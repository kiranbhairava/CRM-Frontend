<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Activity Timeline - Gigaversity</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .material-symbols-outlined { 
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24; 
        }
        .timeline-item {
            position: relative;
            padding-left: 2.5rem;
        }
        .timeline-item:not(:last-child)::before {
            content: '';
            position: absolute;
            left: 0.875rem;
            top: 2.5rem;
            bottom: -1rem;
            width: 2px;
            background: #e5e7eb;
        }
        .timeline-icon {
            position: absolute;
            left: 0;
            top: 0.25rem;
            width: 2rem;
            height: 2rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
        }
        .filter-btn.active {
            background: #1173d4;
            color: white;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <header class="bg-white border-b border-gray-200 shadow-sm sticky top-0 z-10">
        <div class="container mx-auto px-6 lg:px-8 flex items-center justify-between h-16">
            <div class="flex items-center space-x-3">
                <span class="material-symbols-outlined text-blue-600 text-3xl">school</span>
                <h1 class="text-xl font-bold text-gray-900">Gigaversity</h1>
            </div>
            <nav class="hidden md:flex items-center space-x-6">
                <a href="leads.html" class="text-sm font-medium text-gray-500 hover:text-gray-700">Leads</a>
                <a href="sales-managers.html" id="salesTeamLink" class="text-sm font-medium text-gray-500 hover:text-gray-700 hidden">Sales Team</a>
                <a href="demos.html" class="text-sm font-medium text-gray-500 hover:text-gray-700">Demos</a>
                <a href="emails.html" class="text-sm font-medium text-gray-500 hover:text-gray-700">Emails</a>
                <a href="calls.html" class="text-sm font-medium text-gray-500 hover:text-gray-700">Calls</a>
                <a href="timeline.html" class="text-sm font-medium text-primary border-b-2 border-primary pb-1" style="color:#1173d4;">Timeline</a>
                <a href="dashboard.html" class="text-sm font-medium text-gray-500 hover:text-gray-700">Dashboard</a>
                <a href="reports.html" class="text-sm font-medium text-gray-500 hover:text-gray-700">Reports</a>
            </nav>
            <button onclick="logout()" class="text-sm font-medium text-gray-600 hover:text-gray-900">Logout</button>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-6 lg:px-8 py-8">
        <!-- Page Header -->
        <div class="flex items-center justify-between mb-8">
            <div>
                <h2 class="text-3xl font-bold text-gray-900">Activity Timeline</h2>
                <p class="text-gray-500 mt-1">Track all actions and changes across your CRM</p>
            </div>
            <button onclick="refreshTimeline()" class="flex items-center gap-2 px-4 py-2 bg-blue-50 text-blue-600 rounded-lg hover:bg-blue-100 transition-colors">
                <span class="material-symbols-outlined text-xl">refresh</span>
                Refresh
            </button>
        </div>

        <!-- Stats Cards -->
        <div id="statsContainer" class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <!-- Stats will be loaded here -->
        </div>

        <!-- Filters -->
        <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Filters</h3>
            
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <!-- Time Range Filter -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Time Range</label>
                    <select id="daysFilter" onchange="applyFilters()" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        <option value="1">Last 24 hours</option>
                        <option value="7" selected>Last 7 days</option>
                        <option value="30">Last 30 days</option>
                        <option value="90">Last 90 days</option>
                    </select>
                </div>

                <!-- Action Type Filter -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Action Type</label>
                    <select id="actionTypeFilter" onchange="applyFilters()" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        <option value="">All Actions</option>
                        <option value="CREATE">Create</option>
                        <option value="UPDATE">Update</option>
                        <option value="DELETE">Delete</option>
                        <option value="STATUS_CHANGE">Status Change</option>
                        <option value="ASSIGN">Assignment</option>
                        <option value="COMMUNICATION">Communication</option>
                    </select>
                </div>

                <!-- Entity Type Filter -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Entity Type</label>
                    <select id="entityTypeFilter" onchange="applyFilters()" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        <option value="">All Types</option>
                        <option value="lead">Leads</option>
                        <option value="communication">Communications</option>
                        <option value="user">Users</option>
                    </select>
                </div>

                <!-- User Filter (Admin only) -->
                <div id="userFilterContainer" class="hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-2">User</label>
                    <select id="userFilter" onchange="applyFilters()" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        <option value="">All Users</option>
                        <!-- Will be populated dynamically -->
                    </select>
                </div>
            </div>

            <div class="mt-4">
                <button onclick="clearFilters()" class="text-sm text-blue-600 hover:text-blue-700 font-medium">
                    Clear all filters
                </button>
            </div>
        </div>

        <!-- Timeline List -->
        <div class="bg-white rounded-lg shadow-sm">
            <!-- Loading Indicator -->
            <div id="loadingIndicator" class="flex items-center justify-center py-12">
                <div class="inline-block animate-spin rounded-full h-12 w-12 border-4 border-blue-500 border-t-transparent"></div>
            </div>

            <!-- Timeline Content -->
            <div id="timelineContainer" class="hidden p-6">
                <div id="timelineList" class="space-y-6">
                    <!-- Timeline items will be inserted here -->
                </div>

                <!-- Load More Button -->
                <div class="mt-6 text-center">
                    <button id="loadMoreBtn" onclick="loadMore()" class="px-6 py-2 text-sm font-semibold text-blue-600 bg-blue-50 rounded-lg hover:bg-blue-100 transition-colors">
                        Load More
                    </button>
                </div>
            </div>

            <!-- Empty State -->
            <div id="emptyState" class="hidden text-center py-12 px-6">
                <span class="material-symbols-outlined text-gray-300 text-6xl mb-4">history</span>
                <h3 class="text-lg font-semibold text-gray-900 mb-2">No Activity Found</h3>
                <p class="text-gray-500">There are no activities matching your filters.</p>
            </div>
        </div>
    </main>

    <script>
        const API_BASE_URL = 'https://crm-frontend-eta-drab.vercel.app';
        let authToken = localStorage.getItem('authToken');
        let currentUser = null;
        let allTimelineData = [];
        let currentLimit = 50;

        if (!authToken) {
            window.location.href = './login.html';
        }

        async function apiRequest(endpoint, options = {}) {
            const url = `${API_BASE_URL}${endpoint}`;
            const config = {
                headers: {
                    'Content-Type': 'application/json',
                    ...(authToken && { 'Authorization': `Bearer ${authToken}` })
                },
                ...options
            };

            try {
                const response = await fetch(url, config);
                
                if (response.status === 401) {
                    localStorage.removeItem('authToken');
                    window.location.href = './login.html';
                    return;
                }
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                return await response.json();
            } catch (error) {
                console.error('API Error:', error);
                throw error;
            }
        }

        async function initializePage() {
            try {
                currentUser = await apiRequest('/me');
                
                // Show Sales Team link and User filter for admins
                if (currentUser.role === 'ADMIN') {
                    const salesTeamLink = document.getElementById('salesTeamLink');
                    if (salesTeamLink) {
                        salesTeamLink.classList.remove('hidden');
                    }
                    
                    // Show user filter for admins
                    document.getElementById('userFilterContainer').classList.remove('hidden');
                    await loadUsers();
                }
                
                await Promise.all([
                    loadTimeline(),
                    loadStats()
                ]);
            } catch (error) {
                console.error('Failed to initialize page:', error);
                showError('Failed to load timeline data');
            }
        }

        async function loadUsers() {
            try {
                const users = await apiRequest('/sales-managers');
                const userFilter = document.getElementById('userFilter');
                
                users.forEach(user => {
                    const option = document.createElement('option');
                    option.value = user.id;
                    option.textContent = user.name;
                    userFilter.appendChild(option);
                });
            } catch (error) {
                console.error('Failed to load users:', error);
            }
        }

        async function loadStats() {
            try {
                const days = parseInt(document.getElementById('daysFilter').value);
                const stats = await apiRequest(`/timeline/stats?days=${days}`);
                
                displayStats(stats);
            } catch (error) {
                console.error('Failed to load stats:', error);
            }
        }

        function displayStats(stats) {
            const statsContainer = document.getElementById('statsContainer');
            
            const statCards = [
                {
                    title: 'Total Actions',
                    value: stats.total_actions,
                    icon: 'monitoring',
                    color: 'blue'
                },
                {
                    title: 'Leads Created',
                    value: stats.by_action_type['CREATE'] || 0,
                    icon: 'person_add',
                    color: 'green'
                },
                {
                    title: 'Updates Made',
                    value: stats.by_action_type['UPDATE'] || 0,
                    icon: 'edit',
                    color: 'yellow'
                },
                {
                    title: 'Status Changes',
                    value: stats.by_action_type['STATUS_CHANGE'] || 0,
                    icon: 'swap_horiz',
                    color: 'purple'
                }
            ];

            statsContainer.innerHTML = statCards.map(stat => `
                <div class="bg-white rounded-lg shadow-sm p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-600">${stat.title}</p>
                            <p class="text-3xl font-bold text-gray-900 mt-2">${stat.value}</p>
                        </div>
                        <div class="w-12 h-12 bg-${stat.color}-100 rounded-lg flex items-center justify-center">
                            <span class="material-symbols-outlined text-${stat.color}-600 text-2xl">${stat.icon}</span>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        async function loadTimeline() {
            try {
                document.getElementById('loadingIndicator').classList.remove('hidden');
                document.getElementById('timelineContainer').classList.add('hidden');
                document.getElementById('emptyState').classList.add('hidden');

                const days = parseInt(document.getElementById('daysFilter').value);
                const actionType = document.getElementById('actionTypeFilter').value;
                const entityType = document.getElementById('entityTypeFilter').value;
                const userId = document.getElementById('userFilter')?.value || '';

                let url = `/timeline?days=${days}&limit=${currentLimit}`;
                if (actionType) url += `&action_type=${actionType}`;
                if (entityType) url += `&entity_type=${entityType}`;
                if (userId) url += `&user_id=${userId}`;

                allTimelineData = await apiRequest(url);
                
                document.getElementById('loadingIndicator').classList.add('hidden');
                
                if (allTimelineData.length === 0) {
                    document.getElementById('emptyState').classList.remove('hidden');
                } else {
                    document.getElementById('timelineContainer').classList.remove('hidden');
                    displayTimeline(allTimelineData);
                }
            } catch (error) {
                console.error('Failed to load timeline:', error);
                document.getElementById('loadingIndicator').classList.add('hidden');
                showError('Failed to load timeline');
            }
        }

        function displayTimeline(data) {
            const timelineList = document.getElementById('timelineList');
            
            timelineList.innerHTML = data.map(item => {
                const actionConfig = getActionConfig(item.action_type);
                const dateStr = formatDate(item.created_at);
                const timeStr = formatTime(item.created_at);
                
                return `
                    <div class="timeline-item">
                        <div class="timeline-icon bg-${actionConfig.color}-100">
                            <span class="material-symbols-outlined text-${actionConfig.color}-600 text-lg">${actionConfig.icon}</span>
                        </div>
                        <div class="bg-gray-50 rounded-lg p-4">
                            <div class="flex items-start justify-between mb-2">
                                <div>
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-${actionConfig.color}-100 text-${actionConfig.color}-800">
                                        ${item.action_type.replace('_', ' ')}
                                    </span>
                                    <span class="ml-2 text-xs text-gray-500">${item.entity_type}</span>
                                </div>
                                <div class="text-right text-xs text-gray-500">
                                    <div>${dateStr}</div>
                                    <div>${timeStr}</div>
                                </div>
                            </div>
                            <p class="text-sm text-gray-900 font-medium mb-2">${item.description}</p>
                            <div class="flex items-center text-xs text-gray-600">
                                <span class="material-symbols-outlined text-base mr-1">person</span>
                                ${item.user_name}
                            </div>
                            ${item.details ? displayDetails(item.details) : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function getActionConfig(actionType) {
            const configs = {
                'CREATE': { icon: 'add_circle', color: 'green' },
                'UPDATE': { icon: 'edit', color: 'blue' },
                'DELETE': { icon: 'delete', color: 'red' },
                'STATUS_CHANGE': { icon: 'swap_horiz', color: 'purple' },
                'ASSIGN': { icon: 'person_add', color: 'indigo' },
                'COMMUNICATION': { icon: 'chat', color: 'yellow' },
                'EMAIL': { icon: 'email', color: 'teal' },
                'CALL': { icon: 'phone', color: 'orange' },
                'MEETING': { icon: 'event', color: 'pink' }
            };
            
            return configs[actionType] || { icon: 'info', color: 'gray' };
        }

        function displayDetails(details) {
            if (!details || Object.keys(details).length === 0) return '';
            
            let html = '<div class="mt-3 pt-3 border-t border-gray-200 text-xs text-gray-600 space-y-1">';
            
            if (details.changes) {
                html += '<div class="font-medium mb-1">Changes:</div>';
                for (const [field, change] of Object.entries(details.changes)) {
                    html += `<div class="ml-3">• ${field}: <span class="text-gray-400">${change.old || 'empty'}</span> → <span class="text-gray-900">${change.new}</span></div>`;
                }
            } else {
                for (const [key, value] of Object.entries(details)) {
                    if (typeof value === 'object') continue;
                    html += `<div>• ${key}: ${value}</div>`;
                }
                html += '</div>';
            }

            return html;
        }
        function formatDate(isoString) {
            const date = new Date(isoString);
            return date.toLocaleDateString(undefined, { year: 'numeric', month: 'short', day: 'numeric' });
        }

        function formatTime(isoString) {
            const date = new Date(isoString);
            return date.toLocaleTimeString(undefined, { hour: '2-digit', minute: '2-digit' });
        }
        function applyFilters() {
            currentLimit = 50;
            loadTimeline();
            loadStats();
        }
        function clearFilters() {
            document.getElementById('daysFilter').value = '7';
            document.getElementById('actionTypeFilter').value = '';
            document.getElementById('entityTypeFilter').value = '';
            if (document.getElementById('userFilter')) {
                document.getElementById('userFilter').value = '';
            }
            applyFilters();
        }
        function loadMore() {
            currentLimit += 50;
            loadTimeline();
        }
        function refreshTimeline() {
            currentLimit = 50;
            loadTimeline();
            loadStats();
        }
        function showError(message) {
            const timelineContainer = document.getElementById('timelineContainer');
            const emptyState = document.getElementById('emptyState');
            timelineContainer.classList.add('hidden');
            emptyState.classList.remove('hidden');
            emptyState.innerHTML = `
                <span class="material-symbols-outlined text-red-300 text-6xl mb-4">error</span>
                <h3 class="text-lg font-semibold text-gray-900 mb-2">Error</h3>
                <p class="text-gray-500">${message}</p>
            `;
        }
        function logout() {
            localStorage.removeItem('authToken');
            window.location.href = './login.html';
        }
        // Initialize page on load
        window.onload = initializePage;
    </script>
</body>
</html>