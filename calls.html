<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Calls - Gigaversity</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .material-symbols-outlined { font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24; }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <header class="bg-white border-b border-gray-200 shadow-sm sticky top-0 z-10">
        <div class="container mx-auto px-6 lg:px-8 flex items-center justify-between h-16">
            <div class="flex items-center space-x-3">
                <span class="material-symbols-outlined text-blue-600 text-3xl">school</span>
                <h1 class="text-xl font-bold text-gray-900">Gigaversity</h1>
            </div>
            <nav class="hidden md:flex items-center space-x-6">
                <a href="dashboard.html" class="text-sm font-medium text-gray-500 hover:text-gray-700">Dashboard</a>
                <a href="leads.html" class="text-sm font-medium text-gray-500 hover:text-gray-700">Leads</a>
                <a href="calls.html" class="text-sm font-medium text-primary border-b-2 border-primary pb-1" style="color:#1173d4;">Calls</a>
                <a href="demos.html" class="text-sm font-medium text-gray-500 hover:text-gray-700">Demos</a>
                <a href="emails.html" class="text-sm font-medium text-gray-500 hover:text-gray-700">Emails</a>
                <a href="sales-managers.html" id="salesTeamLink" class="text-sm font-medium text-gray-500 hover:text-gray-700 hidden">Sales Team</a>                
                <a href="reports.html" class="text-sm font-medium text-gray-500 hover:text-gray-700">Reports</a>
                <a href="timeline.html" class="text-sm font-medium text-gray-500 hover:text-gray-700">Timeline</a>
            </nav>

            <button onclick="logout()" class="text-sm font-medium text-gray-600 hover:text-gray-900">Logout</button>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-6 lg:px-8 py-8">
        <!-- Page Header -->
        <div class="flex items-center justify-between mb-8">
            <div>
                <h2 class="text-3xl font-bold text-gray-900">Call Logs</h2>
                <p class="text-gray-500 mt-1">Track all call interactions with leads</p>
            </div>
            <div class="flex items-center space-x-3">
                <span id="totalCalls" class="px-4 py-2 bg-purple-100 text-purple-800 font-semibold rounded-lg">0 Calls</span>
            </div>
        </div>

        <!-- Stats Cards -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
            <div class="bg-white rounded-xl shadow-sm p-6 border-l-4 border-purple-500">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-600 font-semibold">Total Calls</p>
                        <p id="totalCallsStat" class="text-3xl font-bold text-gray-900 mt-1">0</p>
                    </div>
                    <span class="material-symbols-outlined text-purple-500 text-4xl">call</span>
                </div>
            </div>
            <div class="bg-white rounded-xl shadow-sm p-6 border-l-4 border-green-500">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-600 font-semibold">Held</p>
                        <p id="heldCalls" class="text-3xl font-bold text-gray-900 mt-1">0</p>
                    </div>
                    <span class="material-symbols-outlined text-green-500 text-4xl">phone_in_talk</span>
                </div>
            </div>
            <div class="bg-white rounded-xl shadow-sm p-6 border-l-4 border-orange-500">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-600 font-semibold">Scheduled</p>
                        <p id="scheduledCalls" class="text-3xl font-bold text-gray-900 mt-1">0</p>
                    </div>
                    <span class="material-symbols-outlined text-orange-500 text-4xl">schedule</span>
                </div>
            </div>
            <div class="bg-white rounded-xl shadow-sm p-6 border-l-4 border-red-500">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-600 font-semibold">Missed</p>
                        <p id="missedCalls" class="text-3xl font-bold text-gray-900 mt-1">0</p>
                    </div>
                    <span class="material-symbols-outlined text-red-500 text-4xl">phone_missed</span>
                </div>
            </div>
        </div>

        <!-- Filters -->
        <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Search</label>
                    <input 
                        type="text" 
                        id="searchInput" 
                        placeholder="Search by lead name..." 
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                        onkeyup="filterCalls()"
                    />
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Status</label>
                    <select 
                        id="statusFilter" 
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                        onchange="filterCalls()"
                    >
                        <option value="">All Statuses</option>
                        <option value="held">Held</option>
                        <option value="scheduled">Scheduled</option>
                        <option value="missed">Missed</option>
                        <option value="no answer">No Answer</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Sales Manager</label>
                    <select 
                        id="managerFilter" 
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                        onchange="filterCalls()"
                    >
                        <option value="">All Managers</option>
                    </select>
                </div>
                <div class="flex items-end">
                    <button 
                        onclick="resetFilters()" 
                        class="w-full px-4 py-2 bg-gray-100 text-gray-700 font-semibold rounded-lg hover:bg-gray-200 transition-colors"
                    >
                        Reset Filters
                    </button>
                </div>
            </div>
        </div>

        <!-- Loading -->
        <div id="loading" class="text-center py-12">
            <div class="inline-block animate-spin rounded-full h-12 w-12 border-4 border-purple-500 border-t-transparent"></div>
            <p class="text-gray-600 mt-4">Loading calls...</p>
        </div>

        <!-- Calls Table -->
        <div id="callsContainer" class="hidden bg-white rounded-xl shadow-sm overflow-hidden">
            <table class="w-full">
                <thead class="bg-gray-50 border-b border-gray-200">
                    <tr>
                        <th class="px-6 py-4 text-left text-xs font-bold text-gray-700 uppercase">Lead</th>
                        <th class="px-6 py-4 text-left text-xs font-bold text-gray-700 uppercase">Sales Manager</th>
                        <th class="px-6 py-4 text-left text-xs font-bold text-gray-700 uppercase">Subject</th>
                        <th class="px-6 py-4 text-left text-xs font-bold text-gray-700 uppercase">Date/Time</th>
                        <th class="px-6 py-4 text-left text-xs font-bold text-gray-700 uppercase">Status</th>
                        <th class="px-6 py-4 text-left text-xs font-bold text-gray-700 uppercase">Actions</th>
                    </tr>
                </thead>
                <tbody id="callsTableBody" class="divide-y divide-gray-200">
                </tbody>
            </table>
        </div>

        <!-- Empty State -->
        <div id="emptyState" class="hidden text-center py-12">
            <span class="material-symbols-outlined text-gray-300 text-6xl">call</span>
            <p class="text-gray-500 font-medium mt-4">No calls logged yet</p>
        </div>
    </main>

    <!-- Call Detail Modal -->
    <div id="callModal" class="hidden fixed inset-0 z-50 bg-black/50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl w-full max-w-2xl shadow-2xl overflow-hidden">
            <div class="bg-gradient-to-r from-purple-500 to-purple-600 px-6 py-4 flex items-center justify-between">
                <h2 class="text-xl font-bold text-white">Call Details</h2>
                <button onclick="closeModal()" class="text-white hover:bg-white/20 rounded-full p-2">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>
            <div class="p-6 max-h-96 overflow-y-auto">
                <div class="space-y-4">
                    <div>
                        <label class="text-sm font-semibold text-gray-700">Lead:</label>
                        <p id="modalLead" class="text-gray-900"></p>
                    </div>
                    <div>
                        <label class="text-sm font-semibold text-gray-700">Subject:</label>
                        <p id="modalSubject" class="text-gray-900"></p>
                    </div>
                    <div>
                        <label class="text-sm font-semibold text-gray-700">Date/Time:</label>
                        <p id="modalDate" class="text-gray-900"></p>
                    </div>
                    <div>
                        <label class="text-sm font-semibold text-gray-700">Status:</label>
                        <p id="modalStatus" class="text-gray-900"></p>
                    </div>
                    <div>
                        <label class="text-sm font-semibold text-gray-700">Notes:</label>
                        <div id="modalContent" class="mt-2 p-4 bg-gray-50 rounded-lg text-gray-900 whitespace-pre-wrap"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Call Modal -->
    <div id="editCallModal" class="hidden fixed inset-0 z-50 bg-black/50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl w-full max-w-2xl shadow-2xl overflow-hidden animate-fadeIn">
            <!-- Modal Header -->
            <div class="bg-gradient-to-r from-yellow-500 to-yellow-600 px-6 py-4 flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-white/20 rounded-full flex items-center justify-center">
                        <span class="material-symbols-outlined text-white">edit</span>
                    </div>
                    <div>
                        <h2 class="text-xl font-bold text-white">Edit Call</h2>
                        <p class="text-yellow-100 text-sm">Update call status and details</p>
                    </div>
                </div>
                <button onclick="closeEditModal()" class="text-white hover:bg-white/20 rounded-full p-2 transition-colors">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>

            <!-- Modal Content -->
            <form id="editCallForm" onsubmit="saveCallChanges(event)" class="p-6 space-y-5">
                <!-- Subject -->
                <div>
                    <label for="editCallSubject" class="block text-sm font-semibold text-gray-700 mb-2">
                        <span class="material-symbols-outlined text-sm align-middle mr-1">subject</span>
                        Subject <span class="text-red-500">*</span>
                    </label>
                    <input 
                        type="text" 
                        id="editCallSubject" 
                        required
                        class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-500 focus:border-transparent"
                        placeholder="Call subject"
                    >
                </div>

                <!-- Call Status -->
                <div>
                    <label for="editCallStatus" class="block text-sm font-semibold text-gray-700 mb-2">
                        <span class="material-symbols-outlined text-sm align-middle mr-1">check_circle</span>
                        Call Status <span class="text-red-500">*</span>
                    </label>
                    <select 
                        id="editCallStatus" 
                        required
                        class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-500 focus:border-transparent appearance-none bg-white"
                    >
                        <option value="">Select Status</option>
                        <option value="scheduled">Scheduled</option>
                        <option value="held">Held</option>
                        <option value="completed">Completed</option>
                        <option value="missed">Missed</option>
                        <option value="no answer">No Answer</option>
                    </select>
                    <p class="text-xs text-gray-500 mt-1">Select 'Held' or 'Completed' for successful calls</p>
                </div>

                <!-- Notes/Description -->
                <div>
                    <label for="editCallNotes" class="block text-sm font-semibold text-gray-700 mb-2">
                        <span class="material-symbols-outlined text-sm align-middle mr-1">description</span>
                        Notes
                    </label>
                    <textarea 
                        id="editCallNotes" 
                        rows="4"
                        class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-500 focus:border-transparent resize-none"
                        placeholder="Update call notes..."
                    ></textarea>
                </div>

                <!-- Action Buttons -->
                <div class="flex items-center justify-end space-x-3 pt-4 border-t border-gray-200">
                    <button 
                        type="button" 
                        onclick="closeEditModal()" 
                        class="px-6 py-2.5 text-sm font-semibold text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors"
                    >
                        Cancel
                    </button>
                    <button 
                        type="submit" 
                        class="px-6 py-2.5 text-sm font-semibold text-white bg-gradient-to-r from-yellow-500 to-yellow-600 rounded-lg hover:from-yellow-600 hover:to-yellow-700 transition-all shadow-sm"
                    >
                        <span class="flex items-center gap-2">
                            <span class="material-symbols-outlined text-base">save</span>
                            Save Changes
                        </span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <style>
    /* Add fade-in animation */
    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: scale(0.95);
        }
        to {
            opacity: 1;
            transform: scale(1);
        }
    }

    .animate-fadeIn {
        animation: fadeIn 0.2s ease-out;
    }
    </style>

<script>
    const API_BASE_URL = 'http://127.0.0.1:8000';
    let authToken = localStorage.getItem('authToken');
    let allCalls = [];
    let allLeads = [];
    let allUsers = [];
    let currentUser = null;

    if (!authToken) {
        window.location.href = './login.html';
    }

    async function apiRequest(endpoint) {
        const response = await fetch(`${API_BASE_URL}${endpoint}`, {
            headers: {
                'Authorization': `Bearer ${authToken}`
            }
        });
        if (response.status === 401) {
            localStorage.removeItem('authToken');
            window.location.href = './login.html';
            return;
        }
        return await response.json();
    }

    async function initializeNavigation() {
        try {
            const user = await apiRequest('/me');
            
            // Show Sales Team link only for admins
            if (user.role === 'ADMIN') {
                const salesTeamLink = document.getElementById('salesTeamLink');
                if (salesTeamLink) {
                    salesTeamLink.classList.remove('hidden');
                }
            }
        } catch (error) {
            console.error('Failed to check user role:', error);
        }
    }

    async function loadData() {
        try {
            // Get current user info first
            await initializeNavigation();
            currentUser = await apiRequest('/me');
            
            // Load users for filter dropdown
            const users = await apiRequest('/sales-managers');
            allUsers = Array.isArray(users) ? users : [];
            
            // Populate manager filter
            const managerFilter = document.getElementById('managerFilter');
            if (allUsers.length > 0) {
                allUsers.forEach(user => {
                    const option = document.createElement('option');
                    option.value = user.id;
                    option.textContent = user.name;
                    managerFilter.appendChild(option);
                });
            }
            
            // Load leads - filter based on user role
            let leads;
            if (currentUser.role === 'ADMIN') {
                leads = await apiRequest('/leads');
            } else {
                const allLeadsData = await apiRequest('/leads');
                leads = allLeadsData.filter(lead => lead.assigned_to === currentUser.id);
            }
            
            allLeads = leads;
            
            // Get all calls from filtered leads only
            allCalls = [];
            for (const lead of leads) {
                try {
                    const comms = await apiRequest(`/leads/${lead.id}/communications`);
                    // Filter for calls only
                    const calls = comms.filter(c => c.type === 'call');
                    
                    // IMPORTANT: For non-admin users, only show calls they created (user_id matches)
                    const filteredCalls = currentUser.role === 'ADMIN' 
                        ? calls 
                        : calls.filter(c => c.user_id === currentUser.id);
                    
                    filteredCalls.forEach(call => {
                        // Find the user who created this call
                        const callCreator = allUsers.find(u => u.id === call.user_id);
                        
                        allCalls.push({
                            ...call,
                            lead_id: lead.id,
                            lead_name: `${lead.first_name} ${lead.last_name}`,
                            lead_email: lead.email_address,
                            manager_id: call.user_id, // The person who made the call
                            manager_name: callCreator?.name || 'Unknown User'
                        });
                    });
                } catch (err) {
                    console.error(`Error loading calls for lead ${lead.id}:`, err);
                }
            }
            
            console.log(`Loaded ${allCalls.length} calls for user ${currentUser.name}`);
            console.log('Sample call:', allCalls[0]);

            renderCalls(allCalls);
            updateStats(allCalls);
            
            document.getElementById('loading').classList.add('hidden');
            
            if (allCalls.length === 0) {
                document.getElementById('emptyState').classList.remove('hidden');
            } else {
                document.getElementById('callsContainer').classList.remove('hidden');
            }
        } catch (err) {
            console.error(err);
            document.getElementById('loading').innerHTML = `
                <span class="material-symbols-outlined text-red-500 text-6xl">error</span>
                <p class="text-red-600 mt-4">Failed to load calls. Please try again.</p>
            `;
        }
    }

    function renderCalls(calls) {
        const tbody = document.getElementById('callsTableBody');
        tbody.innerHTML = '';

        if (calls.length === 0) {
            document.getElementById('callsContainer').classList.add('hidden');
            document.getElementById('emptyState').classList.remove('hidden');
            return;
        }

        document.getElementById('callsContainer').classList.remove('hidden');
        document.getElementById('emptyState').classList.add('hidden');

        calls.forEach(call => {
            const row = document.createElement('tr');
            row.className = 'hover:bg-gray-50 transition-colors';
            
            const statusColors = {
                'held': 'bg-green-100 text-green-800',
                'completed': 'bg-green-100 text-green-800',
                'scheduled': 'bg-orange-100 text-orange-800',
                'missed': 'bg-red-100 text-red-800',
                'no answer': 'bg-gray-100 text-gray-800'
            };
            
            const statusClass = statusColors[call.status] || 'bg-gray-100 text-gray-800';
            
            const callDate = call.completed_at || call.scheduled_at || call.created_at;
            
            row.innerHTML = `
                <td class="px-6 py-4">
                    <div class="font-semibold text-gray-900">${call.lead_name}</div>
                    <div class="text-sm text-gray-500">${call.lead_email}</div>
                </td>
                <td class="px-6 py-4 text-gray-900">${call.manager_name}</td>
                <td class="px-6 py-4 text-gray-900">${call.subject}</td>
                <td class="px-6 py-4 text-gray-900">${new Date(callDate).toLocaleString()}</td>
                <td class="px-6 py-4">
                    <span class="px-3 py-1 ${statusClass} text-xs font-semibold rounded-full uppercase">
                        ${call.status}
                    </span>
                </td>
                <td class="px-6 py-4 flex gap-2">
                    <button onclick="viewCall(${call.id})" class="p-2 text-purple-600 hover:bg-purple-100 rounded-lg transition-colors" title="View Details">
                        <span class="material-symbols-outlined">visibility</span>
                    </button>
                    <button onclick="openEditModal(${call.id})" class="p-2 text-yellow-500 hover:bg-yellow-100 rounded-lg transition-colors" title="Edit Status">
                        <span class="material-symbols-outlined">edit</span>
                    </button>
                </td>
            `;
            
            tbody.appendChild(row);
        });
    }

    let editingCallId = null;

    function openEditModal(callId) {
        const call = allCalls.find(c => c.id === callId);
        if (!call) return;

        editingCallId = callId;
        
        // Populate the edit form
        document.getElementById('editCallSubject').value = call.subject;
        document.getElementById('editCallStatus').value = call.status;
        document.getElementById('editCallNotes').value = call.content || '';
        
        // Show modal
        document.getElementById('editCallModal').classList.remove('hidden');
    }

    function closeEditModal() {
        document.getElementById('editCallModal').classList.add('hidden');
        document.getElementById('editCallForm').reset();
        editingCallId = null;
    }

    async function saveCallChanges(event) {
        event.preventDefault();
        
        if (!editingCallId) return;
        
        const subject = document.getElementById('editCallSubject').value;
        const status = document.getElementById('editCallStatus').value;
        const notes = document.getElementById('editCallNotes').value;
        
        try {
            // Update the communication
            const response = await fetch(`${API_BASE_URL}/communications/${editingCallId}`, {
                method: 'PUT',
                headers: {
                    'Authorization': `Bearer ${authToken}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    subject: subject,
                    status: status,
                    content: notes
                })
            });
            
            if (!response.ok) {
                throw new Error('Failed to update call');
            }
            
            // Show success message
            alert('Call updated successfully!');
            
            // Close modal
            closeEditModal();
            
            // Reload data
            await loadData();
            
        } catch (error) {
            console.error('Error updating call:', error);
            alert('Failed to update call. Please try again.');
        }
    }

    function updateStats(calls) {
        const total = calls.length;
        const held = calls.filter(c => c.status === 'held').length;
        const scheduled = calls.filter(c => c.status === 'scheduled').length;
        const missed = calls.filter(c => c.status === 'missed' || c.status === 'no answer').length;

        document.getElementById('totalCalls').textContent = `${total} Calls`;
        document.getElementById('totalCallsStat').textContent = total;
        document.getElementById('heldCalls').textContent = held;
        document.getElementById('scheduledCalls').textContent = scheduled;
        document.getElementById('missedCalls').textContent = missed;
    }

    function filterCalls() {
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        const statusFilter = document.getElementById('statusFilter').value;
        const managerFilter = document.getElementById('managerFilter').value;

        let filtered = allCalls.filter(call => {
            const matchesSearch = call.lead_name.toLowerCase().includes(searchTerm) ||
                                call.lead_email.toLowerCase().includes(searchTerm) ||
                                call.subject.toLowerCase().includes(searchTerm);
            
            const matchesStatus = !statusFilter || call.status === statusFilter;
            const matchesManager = !managerFilter || call.manager_id == managerFilter;

            return matchesSearch && matchesStatus && matchesManager;
        });

        renderCalls(filtered);
        updateStats(filtered);
    }

    function resetFilters() {
        document.getElementById('searchInput').value = '';
        document.getElementById('statusFilter').value = '';
        document.getElementById('managerFilter').value = '';
        filterCalls();
    }

    function viewCall(callId) {
        const call = allCalls.find(c => c.id === callId);
        if (!call) return;

        document.getElementById('modalLead').textContent = call.lead_name;
        document.getElementById('modalSubject').textContent = call.subject;
        document.getElementById('modalDate').textContent = new Date(call.completed_at || call.scheduled_at || call.created_at).toLocaleString();
        document.getElementById('modalStatus').textContent = call.status.toUpperCase();
        document.getElementById('modalContent').textContent = call.content || 'No notes available';

        document.getElementById('callModal').classList.remove('hidden');
    }

    function closeModal() {
        document.getElementById('callModal').classList.add('hidden');
    }

    function logout() {
        localStorage.removeItem('authToken');
        window.location.href = './login.html';
    }

    // Load data on page load
    loadData();
</script>

</body>
</html>