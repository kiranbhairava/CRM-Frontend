<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <title>Gigaversity - Leads Management</title>
    <link href="data:image/x-icon;base64," rel="icon" type="image/x-icon"/>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com"/>
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>

    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#1173d4",
                        "primary-dark": "#0d5bb5",
                        "background-light": "#f8fafc",
                    },
                    fontFamily: {
                        "display": ["Inter", "sans-serif"]
                    },
                },
            },
        }
    </script>

    <style>
        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        }
        .btn-primary { 
            background: linear-gradient(135deg,#1173d4 0%,#0d5bb5 100%); 
            box-shadow: 0 4px 12px rgba(17,115,212,0.3); 
        }
        .btn-primary:hover { 
            transform: translateY(-1px); 
            box-shadow: 0 6px 16px rgba(17,115,212,0.4); 
        }
        .page-transition { 
            animation: fadeIn 0.5s ease-in; 
        }
        @keyframes fadeIn { 
            from { opacity: 0; transform: translateY(20px); } 
            to { opacity: 1; transform: translateY(0); } 
        }
        .form-label {
            display: block;
            font-size: 0.875rem;
            font-weight: 600;
            color: #374151;
            margin-bottom: 0.5rem;
        }
        .form-input {
            width: 100%;
            padding: 0.625rem 0.875rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            transition: all 0.2s;
        }
        .form-input:focus {
            outline: none;
            border-color: #1173d4;
            box-shadow: 0 0 0 3px rgba(17, 115, 212, 0.1);
        }
        .pagination-btn {
            min-width: 2.5rem;
            height: 2.5rem;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 0.5rem;
            font-weight: 500;
            transition: all 0.2s;
        }
        .pagination-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }
        .pagination-btn.active {
            background: #1173d4;
            color: white;
        }
        .pagination-btn:not(.active):not(:disabled):hover {
            background: #f1f5f9;
        }
        .create-lead-page {
            display: none;
        }
        .create-lead-page.active {
            display: block;
        }
    </style>
</head>
<body class="font-display bg-background-light min-h-screen">

    <!-- LEADS LIST PAGE -->
    <div id="leadsPage">
        <!-- Header -->
        <header class="bg-white/80 border-b border-gray-200 shadow-sm sticky top-0 z-10 backdrop-blur-lg">
            <div class="container mx-auto px-6 lg:px-8">
                <div class="flex items-center justify-between h-16">
                    <div class="flex items-center space-x-3">
                        <span class="material-symbols-outlined text-primary text-3xl">school</span>
                        <h1 class="text-xl font-bold text-gray-900">Gigaversity</h1>
                    </div>
                    <nav class="hidden md:flex items-center space-x-6">
                        <a href="leads.html" class="text-sm font-medium text-primary border-b-2 border-primary pb-1">Leads</a>
                        <a href="sales-managers.html" id="salesTeamLink" class="text-sm font-medium text-gray-500 hover:text-gray-700">Sales Team</a>
                        <a href="demos.html" class="text-sm font-medium text-gray-500 hover:text-gray-700">Demos</a>
                        <a href="dashboard.html" class="text-sm font-medium text-gray-500 hover:text-gray-700">Dashboard</a>
                        <a href="calls.html" class="text-sm font-medium text-gray-500 hover:text-gray-700">Calls</a>
                    </nav>
                    <button onclick="logout()" class="text-sm font-medium text-gray-600 hover:text-gray-900">Logout</button>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="container mx-auto px-6 lg:px-8 py-8 page-transition">
            <!-- Page Header -->
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-8 gap-4">
                <div>
                    <h2 class="text-3xl font-bold text-gray-900">Leads Management</h2>
                    <p class="text-gray-500 mt-1">Manage and track all your leads</p>
                </div>
                <div class="flex items-center gap-3">
                    <button onclick="window.location.href='import-leads.html'" class="flex items-center gap-2 px-5 py-2.5 text-sm font-semibold text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">
                        <span class="material-symbols-outlined text-base">upload</span>
                        <span>Import</span>
                    </button>
                    <button onclick="openCreateLeadPage()" class="flex items-center gap-2 px-6 py-2.5 text-sm font-semibold btn-primary text-white rounded-lg transition-all">
                        <span class="material-symbols-outlined text-base">add</span>
                        <span>New Lead</span>
                    </button>
                </div>
            </div>

            <!-- Search & Filter Bar -->
            <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
                <div class="flex flex-col lg:flex-row gap-4">
                    <div class="flex-1">
                        <div class="relative">
                            <span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">search</span>
                            <input 
                                type="text" 
                                id="searchInput"
                                placeholder="Search by name, email, or phone..." 
                                class="w-full pl-10 pr-4 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:border-primary focus:ring-2 focus:ring-primary/20"
                                oninput="filterLeads()"
                            />
                        </div>
                    </div>
                    <div class="flex flex-wrap gap-2">
                        <button onclick="filterByStatus('all')" class="filter-btn px-5 py-2.5 text-sm font-semibold rounded-lg active bg-primary text-white shadow-sm">All Leads</button>
                        <button onclick="filterByStatus('New')" class="filter-btn px-5 py-2.5 text-sm font-semibold rounded-lg bg-white text-gray-700 border border-gray-200 hover:bg-gray-50">New</button>
                        <button onclick="filterByStatus('Assigned')" class="filter-btn px-5 py-2.5 text-sm font-semibold rounded-lg bg-white text-gray-700 border border-gray-200 hover:bg-gray-50">Assigned</button>
                        <button onclick="filterByStatus('In Process')" class="filter-btn px-5 py-2.5 text-sm font-semibold rounded-lg bg-white text-gray-700 border border-gray-200 hover:bg-gray-50">In Process</button>
                        <button onclick="filterByStatus('Converted')" class="filter-btn px-5 py-2.5 text-sm font-semibold rounded-lg bg-white text-gray-700 border border-gray-200 hover:bg-gray-50">Converted</button>
                    </div>
                </div>
            </div>

            <!-- Loading Indicator -->
            <div id="loadingIndicator" class="hidden text-center py-12">
                <div class="inline-block animate-spin rounded-full h-12 w-12 border-4 border-primary border-t-transparent"></div>
                <p class="text-gray-600 mt-4 font-medium">Loading leads...</p>
            </div>

            <!-- Error Message -->
            <div id="errorMessage" class="hidden bg-red-50 border-l-4 border-red-500 text-red-800 px-6 py-4 rounded-lg mb-6 shadow-sm">
                <div class="flex items-center">
                    <span class="material-symbols-outlined mr-3">error</span>
                    <span id="errorText" class="font-medium"></span>
                </div>
            </div>

            <!-- Leads Table -->
            <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead class="bg-gray-50 border-b border-gray-200">
                            <tr>
                                <th class="px-6 py-4 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">Name</th>
                                <th class="px-6 py-4 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">Status</th>
                                <th class="px-6 py-4 text-left text-xs font-bold text-gray-700 uppercase tracking-wider hidden md:table-cell">Course Interest</th>
                                <th class="px-6 py-4 text-left text-xs font-bold text-gray-700 uppercase tracking-wider hidden lg:table-cell">Source</th>
                                <th class="px-6 py-4 text-left text-xs font-bold text-gray-700 uppercase tracking-wider hidden sm:table-cell">Contact</th>
                                <th class="px-6 py-4 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="leadsTableBody" class="divide-y divide-gray-200">
                            <!-- Leads will be populated here -->
                        </tbody>
                    </table>
                </div>

                <!-- Pagination -->
                <div id="paginationContainer" class="px-6 py-4 bg-gray-50 border-t border-gray-200 flex items-center justify-between">
                    <div class="text-sm text-gray-600">
                        Showing <span id="showingStart" class="font-semibold">0</span> to <span id="showingEnd" class="font-semibold">0</span> of <span id="totalLeads" class="font-semibold">0</span> leads
                    </div>
                    
                    <div class="flex items-center gap-2">
                        <button onclick="goToPage(currentPage - 1)" id="prevBtn" class="pagination-btn px-3 text-gray-700 border border-gray-300">
                            <span class="material-symbols-outlined text-base">chevron_left</span>
                        </button>
                        
                        <div id="pageNumbers" class="flex items-center gap-1">
                            <!-- Page numbers will be inserted here -->
                        </div>
                        
                        <button onclick="goToPage(currentPage + 1)" id="nextBtn" class="pagination-btn px-3 text-gray-700 border border-gray-300">
                            <span class="material-symbols-outlined text-base">chevron_right</span>
                        </button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- CREATE/EDIT LEAD PAGE -->
    <div id="createLeadPage" class="create-lead-page min-h-screen bg-gray-100">
        <header class="bg-white/80 border-b border-gray-200 shadow-sm sticky top-0 z-10 backdrop-blur-lg">
            <div class="container mx-auto px-6 lg:px-8">
                <div class="flex items-center justify-between h-16">
                    <div class="flex items-center gap-4">
                        <button onclick="closeCreateLeadPage()" class="p-2 text-gray-600 hover:bg-gray-100 rounded-full transition-colors">
                            <span class="material-symbols-outlined">arrow_back</span>
                        </button>
                        <div>
                            <h1 class="text-xl font-bold text-gray-900" id="createPageTitle">Create New Lead</h1>
                            <p class="text-xs text-gray-500">Fill in the details below</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-3">
                        <button type="button" onclick="closeCreateLeadPage()" class="px-5 py-2.5 text-sm font-semibold text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">
                            Cancel
                        </button>
                        <button type="submit" form="addLeadForm" class="flex items-center gap-2 px-6 py-2.5 text-sm font-semibold btn-primary text-white rounded-lg transition-all">
                            <span class="material-symbols-outlined text-base">save</span>
                            <span id="saveButtonText">Save Lead</span>
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <main class="container mx-auto max-w-5xl px-6 lg:px-8 py-8">
            <form id="addLeadForm" class="page-transition">
                <div class="bg-white rounded-xl shadow-lg p-6 md:p-8">
                    <!-- Core Information -->
                    <div class="mb-8">
                        <div class="flex items-center gap-3 mb-6">
                            <span class="material-symbols-outlined text-primary text-2xl">person</span>
                            <div>
                                <h3 class="text-lg font-bold text-gray-800">Core Information</h3>
                                <p class="text-sm text-gray-500">Primary contact details</p>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div>
                                <label for="salutation" class="form-label">Salutation</label>
                                <select id="salutation" class="form-input">
                                    <option value="">Select</option>
                                    <option value="Mr.">Mr.</option>
                                    <option value="Ms.">Ms.</option>
                                    <option value="Mrs.">Mrs.</option>
                                    <option value="Dr.">Dr.</option>
                                </select>
                            </div>
                            <div>
                                <label for="firstName" class="form-label">First Name <span class="text-red-500">*</span></label>
                                <input type="text" id="firstName" class="form-input" placeholder="John" required>
                            </div>
                            <div>
                                <label for="lastName" class="form-label">Last Name <span class="text-red-500">*</span></label>
                                <input type="text" id="lastName" class="form-input" placeholder="Doe" required>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
                            <div>
                                <label for="email" class="form-label">Email Address <span class="text-red-500">*</span></label>
                                <input type="email" id="email" class="form-input" placeholder="john.doe@example.com" required>
                            </div>
                            <div>
                                <label for="mobileNumber" class="form-label">Mobile Number <span class="text-red-500">*</span></label>
                                <input type="tel" id="mobileNumber" class="form-input" placeholder="+91 98765 43210" required>
                            </div>
                            <div>
                                <label for="alternateMobile" class="form-label">Alternate Mobile</label>
                                <input type="tel" id="alternateMobile" class="form-input" placeholder="+91 98765 43211">
                            </div>
                            <div>
                                <label for="workingStatus" class="form-label">Working Status</label>
                                <select id="workingStatus" class="form-input">
                                    <option value="">Select</option>
                                    <option value="Student">Student</option>
                                    <option value="Working Professional">Working Professional</option>
                                    <option value="Unemployed">Unemployed</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Address Information -->
                    <div class="mb-8 pt-8 border-t border-gray-200">
                        <div class="flex items-center gap-3 mb-6">
                            <span class="material-symbols-outlined text-primary text-2xl">location_on</span>
                            <div>
                                <h3 class="text-lg font-bold text-gray-800">Address Information</h3>
                                <p class="text-sm text-gray-500">Location details</p>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="md:col-span-2">
                                <label for="street" class="form-label">Street</label>
                                <input type="text" id="street" class="form-input" placeholder="123 Main Street">
                            </div>
                            <div>
                                <label for="city" class="form-label">City</label>
                                <input type="text" id="city" class="form-input" placeholder="Mumbai">
                            </div>
                            <div>
                                <label for="state" class="form-label">State</label>
                                <input type="text" id="state" class="form-input" placeholder="Maharashtra">
                            </div>
                            <div>
                                <label for="postalCode" class="form-label">Postal Code</label>
                                <input type="text" id="postalCode" class="form-input" placeholder="400001">
                            </div>
                            <div>
                                <label for="country" class="form-label">Country</label>
                                <input type="text" id="country" class="form-input" placeholder="India" value="India">
                            </div>
                        </div>
                    </div>

                    <!-- Education & Lead Information -->
                    <div class="mb-8 pt-8 border-t border-gray-200">
                        <div class="flex items-center gap-3 mb-6">
                            <span class="material-symbols-outlined text-primary text-2xl">school</span>
                            <div>
                                <h3 class="text-lg font-bold text-gray-800">Education & Lead Details</h3>
                                <p class="text-sm text-gray-500">Academic background and lead information</p>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label for="instituteName" class="form-label">Institute Name</label>
                                <input type="text" id="instituteName" class="form-input" placeholder="University Name">
                            </div>
                            <div>
                                <label for="qualification" class="form-label">Qualification</label>
                                <input type="text" id="qualification" class="form-input" placeholder="B.Tech, MBA, etc.">
                            </div>
                            <div>
                                <label for="courseInterest" class="form-label">Course Interested In</label>
                                <input type="text" id="courseInterest" class="form-input" placeholder="Data Science, Web Development, etc.">
                            </div>
                            <div>
                                <label for="opportunityAmount" class="form-label">Opportunity Amount</label>
                                <input type="number" id="opportunityAmount" class="form-input" placeholder="50000">
                            </div>
                            <div>
                                <label for="leadSource" class="form-label">Lead Source</label>
                                <select id="leadSource" class="form-input">
                                    <option value="">Select</option>
                                    <option value="Cold Call">Cold Call</option>
                                    <option value="Existing Customer">Existing Customer</option>
                                    <option value="Self Generated">Self Generated</option>
                                    <option value="Employee">Employee</option>
                                    <option value="Partner">Partner</option>
                                    <option value="Public Relations">Public Relations</option>
                                    <option value="Direct Mail">Direct Mail</option>
                                    <option value="Conference">Conference</option>
                                    <option value="Trade Show">Trade Show</option>
                                    <option value="Website">Website</option>
                                    <option value="Word of Mouth">Word of Mouth</option>
                                    <option value="Email">Email</option>
                                    <option value="Campaign">Campaign</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                            <div>
                                <label for="referredBy" class="form-label">Referred By</label>
                                <input type="text" id="referredBy" class="form-input" placeholder="Name of referrer">
                            </div>
                            <div>
                                <label for="status" class="form-label">Status</label>
                                <select id="status" class="form-input">
                                    <option value="New">New</option>
                                    <option value="Assigned">Assigned</option>
                                    <option value="In Process">In Process</option>
                                    <option value="Converted">Converted</option>
                                    <option value="Recycled">Recycled</option>
                                    <option value="Dead">Dead</option>
                                </select>
                            </div>
                            <div>
                                <label for="statusDescription" class="form-label">Status Description</label>
                                <input type="text" id="statusDescription" class="form-input" placeholder="Additional status notes">
                            </div>
                            <div>
                                <label for="assignedTo" class="form-label">Assigned To</label>
                                <select id="assignedTo" class="form-input">
                                    <option value="">Select User</option>
                                </select>
                            </div>
                        </div>
                        <div class="mt-6">
                            <label for="description" class="form-label">Description / Notes</label>
                            <textarea id="description" rows="4" class="form-input" placeholder="Additional notes about the lead..."></textarea>
                        </div>
                    </div>
                </div>
            </form>
        </main>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="deleteModal" class="hidden fixed inset-0 z-50 bg-black/50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl p-6 max-w-md w-full shadow-2xl">
            <div class="flex items-center gap-3 mb-4">
                <div class="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center">
                    <span class="material-symbols-outlined text-red-600">delete</span>
                </div>
                <div>
                    <h3 class="text-lg font-bold text-gray-900">Delete Lead</h3>
                    <p class="text-sm text-gray-500">This action cannot be undone</p>
                </div>
            </div>
            <p class="text-gray-600 mb-6">Are you sure you want to delete this lead? All associated data will be permanently removed.</p>
            <div class="flex gap-3">
                <button onclick="closeDeleteModal()" class="flex-1 px-4 py-2.5 text-sm font-semibold text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors">
                    Cancel
                </button>
                <button onclick="confirmDelete()" class="flex-1 px-4 py-2.5 text-sm font-semibold text-white bg-red-600 hover:bg-red-700 rounded-lg transition-colors">
                    Delete Lead
                </button>
            </div>
        </div>
    </div>
    <!-- Admin Warning Modal -->
    <div id="adminWarningModal" class="hidden fixed inset-0 z-50 bg-black/50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl p-6 max-w-md w-full shadow-2xl">
            <div class="flex items-center gap-3 mb-4">
                <div class="w-12 h-12 bg-yellow-100 rounded-full flex items-center justify-center">
                    <span class="material-symbols-outlined text-yellow-600">warning</span>
                </div>
                <div>
                    <h3 class="text-lg font-bold text-gray-900">Admin Permission Required</h3>
                    <p class="text-sm text-gray-500">Restricted Action</p>
                </div>
            </div>
            <p class="text-gray-600 mb-6">Only administrators can delete leads. Please contact your admin if you need to remove this lead.</p>
            <div class="flex justify-end">
                <button onclick="closeAdminWarning()" class="px-6 py-2.5 text-sm font-semibold text-white bg-primary hover:bg-primary-dark rounded-lg transition-colors">
                    Got it
                </button>
            </div>
        </div>
    </div>

<script>
        const API_BASE_URL = 'https://crm-1-ss55.onrender.com';
        let authToken = localStorage.getItem('authToken');
        let currentUser = null;
        let allLeads = [];
        let filteredLeads = [];
        let currentPage = 1;
        const leadsPerPage = 10;
        let currentFilter = 'all';
        let editingLeadId = null;
        let deletingLeadId = null;

        if (!authToken) {
            window.location.href = './login.html';
        }

        async function apiRequest(endpoint, options = {}) {
            const url = `${API_BASE_URL}${endpoint}`;
            const config = {
                headers: {
                    'Content-Type': 'application/json',
                    ...(authToken && { 'Authorization': `Bearer ${authToken}` })
                },
                ...options
            };

            try {
                const response = await fetch(url, config);
                
                if (response.status === 401) {
                    localStorage.removeItem('authToken');
                    window.location.href = './login.html';
                    return;
                }
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(errorText || `HTTP ${response.status}`);
                }
                
                return await response.json();
            } catch (error) {
                console.error('API Error:', error);
                throw error;
            }
        }

        async function init() {
            try {
                currentUser = await apiRequest('/me');
                
                if (currentUser.role !== 'ADMIN') {
                    const salesTeamLink = document.getElementById('salesTeamLink');
                    if (salesTeamLink) salesTeamLink.style.display = 'none';
                }

                await loadLeads();
                await loadSalesManagers();
                
                const urlParams = new URLSearchParams(window.location.search);
                if (urlParams.get('edit') === 'true') {
                    const editData = sessionStorage.getItem('editLeadData');
                    if (editData) {
                        const lead = JSON.parse(editData);
                        openEditLeadPage(lead.id);
                        sessionStorage.removeItem('editLeadData');
                    }
                }
            } catch (error) {
                showError('Failed to initialize: ' + error.message);
            }
        }

        async function loadLeads() {
            try {
                showLoading(true);
                hideError();
                const leads = await apiRequest('/leads');
                allLeads = leads || [];
                filteredLeads = [...allLeads];
                renderLeads(allLeads);
            } catch (error) {
                showError('Failed to load leads: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        async function loadSalesManagers() {
            try {
                if (currentUser.role === 'ADMIN') {
                    const users = await apiRequest('/sales-managers');
                    const assignedToSelect = document.getElementById('assignedTo');
                    assignedToSelect.innerHTML = '<option value="">Select User</option>';
                    users.forEach(user => {
                        const option = document.createElement('option');
                        option.value = user.id;
                        option.textContent = user.name;
                        assignedToSelect.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Failed to load sales managers:', error);
            }
        }

        function renderLeads(leads) {
        filteredLeads = leads;
        const totalPages = Math.ceil(filteredLeads.length / leadsPerPage);
        
        if (currentPage > totalPages && totalPages > 0) {
            currentPage = 1;
        }
        
        const startIndex = (currentPage - 1) * leadsPerPage;
        const endIndex = Math.min(startIndex + leadsPerPage, filteredLeads.length);
        const paginatedLeads = filteredLeads.slice(startIndex, endIndex);
        
        const tbody = document.getElementById('leadsTableBody');
        
        if (!paginatedLeads || paginatedLeads.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="6" class="px-6 py-12 text-center">
                        <span class="material-symbols-outlined text-gray-300 text-6xl">folder_open</span>
                        <p class="text-gray-500 font-medium mt-2">No leads found</p>
                        <p class="text-gray-400 text-sm mt-1">Create your first lead to get started</p>
                    </td>
                </tr>`;
            updatePaginationUI(0, 0, 0);
            return;
        }

        const statusColors = {
            'New': 'bg-blue-100 text-blue-800',
            'Assigned': 'bg-yellow-100 text-yellow-800',
            'In Process': 'bg-orange-100 text-orange-800',
            'Converted': 'bg-green-100 text-green-800',
            'Recycled': 'bg-purple-100 text-purple-800',
            'Dead': 'bg-red-100 text-red-800'
        };

        // Check if current user is admin
        const isAdmin = currentUser && currentUser.role === 'ADMIN';

        tbody.innerHTML = paginatedLeads.map(lead => `
            <tr class="hover:bg-gray-50 transition-colors">
                <td class="px-6 py-4 font-semibold text-gray-900">
                    ${lead.first_name || ''} ${lead.last_name || ''}
                </td>
                <td class="px-6 py-4">
                    <span class="px-3 py-1 text-xs font-bold rounded-full ${statusColors[lead.status] || 'bg-gray-100 text-gray-800'}">
                        ${lead.status || 'New'}
                    </span>
                </td>
                <td class="px-6 py-4 hidden md:table-cell text-gray-700 font-medium">
                    ${lead.course_interested_in || '-'}
                </td>
                <td class="px-6 py-4 hidden lg:table-cell text-gray-600">
                    ${lead.lead_source || '-'}
                </td>
                <td class="px-6 py-4 hidden sm:table-cell">
                    <div class="text-gray-700 font-medium">${lead.email_address || ''}</div>
                    <div class="text-xs text-gray-500 mt-1">${lead.mobile_number || ''}</div>
                </td>
                <td class="px-6 py-4 flex gap-2">
                    <button onclick="viewLeadDetail(${lead.id})" class="p-2 text-primary hover:bg-primary/10 rounded-lg transition-colors" title="View">
                        <span class="material-symbols-outlined">visibility</span>
                    </button>
                    <button onclick="openEditLeadPage(${lead.id})" class="p-2 text-yellow-500 hover:bg-yellow-100 rounded-lg transition-colors" title="Edit">
                        <span class="material-symbols-outlined">edit</span>
                    </button>
                    ${isAdmin ? `
                        <button onclick="showDeleteModal(${lead.id})" class="p-2 text-red-500 hover:bg-red-100 rounded-lg transition-colors" title="Delete">
                            <span class="material-symbols-outlined">delete</span>
                        </button>
                    ` : `
                        <button onclick="showAdminWarning()" class="p-2 text-gray-400 cursor-not-allowed rounded-lg" title="Admin permission required" disabled>
                            <span class="material-symbols-outlined">delete</span>
                        </button>
                    `}
                </td>
            </tr>
        `).join('');

        updatePaginationUI(startIndex, endIndex, filteredLeads.length);
    }

    // Add this new function to show warning
    function showAdminWarning() {
        document.getElementById('adminWarningModal').classList.remove('hidden');
    }
    
    function closeAdminWarning() {
        document.getElementById('adminWarningModal').classList.add('hidden');
    }

    function updatePaginationUI(startIndex, endIndex, totalLeads) {
        const totalPages = Math.ceil(totalLeads / leadsPerPage);
            
            document.getElementById('showingStart').textContent = totalLeads > 0 ? startIndex + 1 : 0;
            document.getElementById('showingEnd').textContent = endIndex;
            document.getElementById('totalLeads').textContent = totalLeads;
            
            document.getElementById('prevBtn').disabled = currentPage === 1;
            document.getElementById('nextBtn').disabled = currentPage === totalPages || totalPages === 0;
            
            const pageNumbersContainer = document.getElementById('pageNumbers');
            pageNumbersContainer.innerHTML = '';
            
            if (totalPages <= 7) {
                for (let i = 1; i <= totalPages; i++) {
                    pageNumbersContainer.appendChild(createPageButton(i));
                }
            } else {
                pageNumbersContainer.appendChild(createPageButton(1));
                
                if (currentPage > 3) {
                    pageNumbersContainer.appendChild(createEllipsis());
                }
                
                let start = Math.max(2, currentPage - 1);
                let end = Math.min(totalPages - 1, currentPage + 1);
                
                for (let i = start; i <= end; i++) {
                    pageNumbersContainer.appendChild(createPageButton(i));
                }
                
                if (currentPage < totalPages - 2) {
                    pageNumbersContainer.appendChild(createEllipsis());
                }
                
                pageNumbersContainer.appendChild(createPageButton(totalPages));
            }
        }

        function createPageButton(pageNum) {
            const button = document.createElement('button');
            button.className = `pagination-btn ${pageNum === currentPage ? 'active' : 'text-gray-700 border border-gray-300'}`;
            button.textContent = pageNum;
            button.onclick = () => goToPage(pageNum);
            return button;
        }

        function createEllipsis() {
            const span = document.createElement('span');
            span.className = 'px-2 text-gray-500';
            span.textContent = '...';
            return span;
        }

        function goToPage(page) {
            const totalPages = Math.ceil(filteredLeads.length / leadsPerPage);
            if (page < 1 || page > totalPages) return;
            
            currentPage = page;
            renderLeads(filteredLeads);
            
            document.getElementById('leadsTableBody').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function filterByStatus(status) {
            currentFilter = status;
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active', 'bg-primary', 'text-white', 'shadow-sm');
                btn.classList.add('bg-white', 'text-gray-700', 'border', 'border-gray-200');
            });
            
            const buttons = document.querySelectorAll('.filter-btn');
            buttons.forEach(btn => {
                if (btn.textContent.trim() === status || (status === 'all' && btn.textContent.trim() === 'All Leads')) {
                    btn.classList.remove('bg-white', 'text-gray-700', 'border', 'border-gray-200');
                    btn.classList.add('active', 'bg-primary', 'text-white', 'shadow-sm');
                }
            });
            
            applyFilters();
        }

        function filterLeads() {
            applyFilters();
        }

        function applyFilters() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            let filtered = allLeads;

            if (currentFilter !== 'all') {
                filtered = filtered.filter(lead => lead.status === currentFilter);
            }

            if (searchTerm) {
                filtered = filtered.filter(lead => 
                    (lead.first_name && lead.first_name.toLowerCase().includes(searchTerm)) ||
                    (lead.last_name && lead.last_name.toLowerCase().includes(searchTerm)) ||
                    (lead.email_address && lead.email_address.toLowerCase().includes(searchTerm)) ||
                    (lead.mobile_number && lead.mobile_number.includes(searchTerm))
                );
            }

            currentPage = 1;
            renderLeads(filtered);
        }

        function viewLeadDetail(leadId) {
            window.location.href = `lead-detail.html?id=${leadId}`;
        }

        function openCreateLeadPage() {
            editingLeadId = null;
            document.getElementById('createPageTitle').textContent = 'Create New Lead';
            document.getElementById('saveButtonText').textContent = 'Save Lead';
            document.getElementById('addLeadForm').reset();
            document.getElementById('status').value = 'New';
            document.getElementById('leadsPage').style.display = 'none';
            document.getElementById('createLeadPage').classList.add('active');
            window.scrollTo(0, 0);
        }

        function closeCreateLeadPage() {
            document.getElementById('createLeadPage').classList.remove('active');
            document.getElementById('leadsPage').style.display = 'block';
            document.getElementById('addLeadForm').reset();
            editingLeadId = null;
            window.scrollTo(0, 0);
        }

        function openEditLeadPage(leadId) {
            const lead = allLeads.find(l => l.id === leadId);
            if (!lead) {
                showError('Lead not found');
                return;
            }

            editingLeadId = leadId;
            document.getElementById('createPageTitle').textContent = 'Edit Lead';
            document.getElementById('saveButtonText').textContent = 'Update Lead';

            document.getElementById('salutation').value = lead.salutation || '';
            document.getElementById('firstName').value = lead.first_name || '';
            document.getElementById('lastName').value = lead.last_name || '';
            document.getElementById('email').value = lead.email_address || '';
            document.getElementById('mobileNumber').value = lead.mobile_number || '';
            document.getElementById('alternateMobile').value = lead.alternate_mobile_number || '';
            document.getElementById('workingStatus').value = lead.working_status || '';
            document.getElementById('street').value = lead.street || '';
            document.getElementById('city').value = lead.city || '';
            document.getElementById('state').value = lead.state || '';
            document.getElementById('postalCode').value = lead.postal_code || '';
            document.getElementById('country').value = lead.country || '';
            document.getElementById('instituteName').value = lead.institute_name || '';
            document.getElementById('qualification').value = lead.qualification || '';
            document.getElementById('courseInterest').value = lead.course_interested_in || '';
            document.getElementById('opportunityAmount').value = lead.opportunity_amount || '';
            document.getElementById('leadSource').value = lead.lead_source || '';
            document.getElementById('referredBy').value = lead.referred_by || '';
            document.getElementById('status').value = lead.status || 'New';
            document.getElementById('statusDescription').value = lead.status_description || '';
            document.getElementById('assignedTo').value = lead.assigned_to || '';
            document.getElementById('description').value = lead.description || '';

            document.getElementById('leadsPage').style.display = 'none';
            document.getElementById('createLeadPage').classList.add('active');
            window.scrollTo(0, 0);
        }

        document.getElementById('addLeadForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const leadData = {
                salutation: document.getElementById('salutation').value || null,
                first_name: document.getElementById('firstName').value.trim(),
                last_name: document.getElementById('lastName').value.trim(),
                email_address: document.getElementById('email').value.trim(),
                mobile_number: document.getElementById('mobileNumber').value.trim(),
                alternate_mobile_number: document.getElementById('alternateMobile').value.trim() || null,
                working_status: document.getElementById('workingStatus').value || null,
                street: document.getElementById('street').value.trim() || null,
                city: document.getElementById('city').value.trim() || null,
                state: document.getElementById('state').value.trim() || null,
                postal_code: document.getElementById('postalCode').value.trim() || null,
                country: document.getElementById('country').value.trim() || null,
                institute_name: document.getElementById('instituteName').value.trim() || null,
                qualification: document.getElementById('qualification').value.trim() || null,
                course_interested_in: document.getElementById('courseInterest').value.trim() || null,
                opportunity_amount: parseFloat(document.getElementById('opportunityAmount').value) || null,
                lead_source: document.getElementById('leadSource').value || null,
                referred_by: document.getElementById('referredBy').value.trim() || null,
                status: document.getElementById('status').value || 'New',
                status_description: document.getElementById('statusDescription').value.trim() || null,
                assigned_to: parseInt(document.getElementById('assignedTo').value) || null,
                description: document.getElementById('description').value.trim() || null
            };

            try {
                if (editingLeadId) {
                    const updatedLead = await apiRequest(`/leads/${editingLeadId}`, {
                        method: 'PUT',
                        body: JSON.stringify(leadData)
                    });
                    const index = allLeads.findIndex(l => l.id === editingLeadId);
                    allLeads[index] = updatedLead;
                    editingLeadId = null;
                    showSuccess('Lead updated successfully!');
                    
                    const returnToDetail = sessionStorage.getItem('returnToLeadDetail');
                    if (returnToDetail) {
                        sessionStorage.removeItem('returnToLeadDetail');
                        sessionStorage.setItem('leadJustEdited', 'true');
                        window.location.href = `lead-detail.html?id=${returnToDetail}`;
                        return;
                    }
                } else {
                    const newLead = await apiRequest('/leads', {
                        method: 'POST',
                        body: JSON.stringify(leadData)
                    });
                    allLeads.push(newLead);
                    showSuccess('Lead created successfully!');
                }

                closeCreateLeadPage();
                renderLeads(allLeads);
                applyFilters();
            } catch (error) {
                showError((editingLeadId ? 'Failed to update' : 'Failed to create') + ' lead: ' + error.message);
            }
        });

        function showDeleteModal(leadId) {
            deletingLeadId = leadId;
            document.getElementById('deleteModal').classList.remove('hidden');
        }

        function closeDeleteModal() {
            deletingLeadId = null;
            document.getElementById('deleteModal').classList.add('hidden');
        }

        async function confirmDelete() {
            if (!deletingLeadId) return;

            try {
                await apiRequest(`/leads/${deletingLeadId}`, {
                    method: 'DELETE'
                });
                
                allLeads = allLeads.filter(l => l.id !== deletingLeadId);
                showSuccess('Lead deleted successfully!');
                closeDeleteModal();
                applyFilters();
            } catch (error) {
                showError('Failed to delete lead: ' + error.message);
            }
        }

        function showLoading(show) {
            document.getElementById('loadingIndicator').classList.toggle('hidden', !show);
        }

        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            document.getElementById('errorText').textContent = message;
            errorDiv.classList.remove('hidden');
            setTimeout(() => {
                errorDiv.classList.add('hidden');
            }, 5000);
        }

        function hideError() {
            document.getElementById('errorMessage').classList.add('hidden');
        }

        function showSuccess(message) {
            alert(message);
        }

        function logout() {
            localStorage.removeItem('authToken');
            window.location.href = './login.html';
        }

        init();
    </script>
</body>
</html>