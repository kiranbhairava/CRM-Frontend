<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <title>Lead Details - Gigaversity</title>
    <link href="data:image/x-icon;base64," rel="icon" type="image/x-icon"/>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com"/>
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
    
    <style>
        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        }
        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        .timeline-item {
            position: relative;
            padding-left: 24px;
            margin-bottom: 24px;
        }
        .timeline-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 6px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #1173d4;
        }
        .timeline-item::after {
            content: '';
            position: absolute;
            left: 5px;
            top: 24px;
            bottom: -24px;
            width: 2px;
            background: #e2e8f0;
        }
        .timeline-item:last-child::after {
            display: none;
        }
        .form-input { 
            width: 100%; 
            border: 1.5px solid #e2e8f0; 
            border-radius: 8px; 
            padding: 10px 14px; 
            font-size: 14px; 
        }
        .form-input:focus { 
            outline: none; 
            border-color: #1173d4; 
            box-shadow: 0 0 0 3px rgba(17,115,212,0.1); 
        }

        .timeline-container {
            max-height: 600px; /* Adjust height as needed */
            overflow-y: auto;
            padding-right: 10px;
        }

        /* Add custom scrollbar styling for better appearance (optional) */
        .timeline-container::-webkit-scrollbar {
            width: 8px;
        }

        .timeline-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        .timeline-container::-webkit-scrollbar-thumb {
            background: #c5c5c5;
            border-radius: 10px;
        }

        .timeline-container::-webkit-scrollbar-thumb:hover {
            background: #a0a0a0;
        }
    </style>
</head>
<body class="font-sans bg-gray-50">
    <!-- Header -->
    <header class="bg-white shadow-sm border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center">
                    <button onclick="goBack()" class="mr-4 p-2 text-gray-500 hover:bg-gray-100 rounded-full transition-colors">
                        <span class="material-symbols-outlined">arrow_back</span>
                    </button>
                    <div>
                        <h1 class="text-xl font-bold text-gray-900">Lead Details</h1>
                        <p class="text-sm text-gray-500">View and manage lead information</p>
                    </div>
                </div>
                <!-- <div class="flex items-center space-x-3">
                    <button onclick="editLead()" class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">
                        Edit Lead
                    </button>
                    <button onclick="deleteLead()" class="px-4 py-2 text-sm font-medium text-white bg-red-600 rounded-lg hover:bg-red-700 transition-colors">
                        Delete Lead
                    </button>
                </div> -->
            </div>
        </div>
    </header>

    <!-- Loading Indicator -->
    <div id="loadingIndicator" class="hidden text-center py-12">
        <div class="inline-block animate-spin rounded-full h-12 w-12 border-4 border-blue-500 border-t-transparent"></div>
        <p class="text-gray-600 mt-4 font-medium">Loading lead details...</p>
    </div>

    <div id="toast-container" class="fixed bottom-5 right-5 z-50"></div>

    <!-- Error Message -->
    <div id="errorMessage" class="hidden bg-red-50 border-l-4 border-red-500 text-red-800 px-6 py-4 rounded-lg mb-6 shadow-sm mx-4 mt-4">
        <div class="flex items-center">
            <span class="material-symbols-outlined mr-3">error</span>
            <span id="errorText" class="font-medium"></span>
        </div>
    </div>

    <!-- Main Content -->
    <main id="mainContent" class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Left Column - Lead Info -->
            <div class="lg:col-span-2 space-y-6">
                <!-- Lead Header Card -->
                <div class="bg-white rounded-xl shadow-sm p-6">
                    <div class="flex flex-col md:flex-row md:items-start justify-between">
                        <div class="flex items-start space-x-4">
                            <div id="leadAvatar" class="w-16 h-16 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-full flex items-center justify-center text-white font-bold text-xl">
                                <!-- Initials will be set dynamically -->
                            </div>
                            <div>
                                <div class="flex items-center space-x-2 mb-1">
                                    <h2 id="leadName" class="text-2xl font-bold text-gray-900">Loading...</h2>
                                    <span id="leadStatusBadge" class="status-badge bg-blue-100 text-blue-800">New</span>
                                </div>
                                <div class="flex flex-wrap items-center gap-4 text-sm text-gray-600">
                                    <div class="flex items-center">
                                        <span class="material-symbols-outlined text-base mr-1">mail</span>
                                        <span id="leadEmail">Loading...</span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <span class="material-symbols-outlined text-base mr-1">call</span>
                                        <span id="leadPhone">Loading...</span>
                                        <button onclick="messageWhatsApp()" class="ml-2 text-emerald-600 hover:text-emerald-700 transition-colors" title="Message on WhatsApp">
                                            <span class="material-symbols-outlined text-base">chat</span>
                                        </button>
                                    </div>
                                    <div class="flex items-center">
                                        <span class="material-symbols-outlined text-base mr-1">location_on</span>
                                        <span id="leadLocation">Loading...</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="mt-4 md:mt-0 flex space-x-2">
                            <button onclick="callLead()" class="flex items-center space-x-1 px-4 py-2 text-sm font-medium text-white bg-green-600 rounded-lg hover:bg-green-700 transition-colors">
                                <span class="material-symbols-outlined text-base">call</span>
                                <span>Call</span>
                            </button>
                            <button onclick="messageWhatsApp()" class="flex items-center space-x-1 px-4 py-2 text-sm font-medium text-white bg-emerald-600 rounded-lg hover:bg-emerald-700 transition-colors">
                                <span class="material-symbols-outlined text-base">chat</span>
                                <span>WhatsApp</span>
                            </button>
                            <button onclick="openEmailModal()" class="flex items-center space-x-1 px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700 transition-colors">
                                <span class="material-symbols-outlined text-base">mail</span>
                                <span>Email</span>
                            </button>
                            <button onclick="openCalendarModal()" class="flex items-center space-x-1 px-4 py-2 text-sm font-medium text-white bg-purple-600 rounded-lg hover:bg-purple-700 transition-colors">
                                <span class="material-symbols-outlined text-base">event</span>
                                <span>Meeting</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Details Card -->
                <div class="bg-white rounded-xl shadow-sm p-6">
                    <h3 class="text-lg font-bold text-gray-900 mb-4">Lead Information</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <h4 class="text-sm font-medium text-gray-500 mb-2">Personal Details</h4>
                            <div class="space-y-3">
                                <div>
                                    <p class="text-xs text-gray-500">Full Name</p>
                                    <p id="fullName" class="text-sm font-medium">Loading...</p>
                                </div>
                                <div>
                                    <p class="text-xs text-gray-500">Email</p>
                                    <p id="detailEmail" class="text-sm font-medium">Loading...</p>
                                </div>
                                <div>
                                    <p class="text-xs text-gray-500">Phone</p>
                                    <p id="detailPhone" class="text-sm font-medium">Loading...</p>
                                </div>
                                <div>
                                    <p class="text-xs text-gray-500">Location</p>
                                    <p id="detailLocation" class="text-sm font-medium">Loading...</p>
                                </div>
                            </div>
                        </div>
                        <div>
                            <h4 class="text-sm font-medium text-gray-500 mb-2">Lead Details</h4>
                            <div class="space-y-3">
                                <div>
                                    <p class="text-xs text-gray-500">Lead Source</p>
                                    <p id="leadSource" class="text-sm font-medium">Loading...</p>
                                </div>
                                <div>
                                    <p class="text-xs text-gray-500">Course Interest</p>
                                    <p id="courseInterest" class="text-sm font-medium">Loading...</p>
                                </div>
                                <div>
                                    <p class="text-xs text-gray-500">Educational Background</p>
                                    <p id="education" class="text-sm font-medium">Loading...</p>
                                </div>
                                <div>
                                    <p class="text-xs text-gray-500">Assigned To</p>
                                    <p id="assignedTo" class="text-sm font-medium">Loading...</p>
                                </div>
                                <div>
                                    <p class="text-xs text-gray-500">Opportunity Amount</p>
                                    <p id="opportunityAmount" class="text-sm font-medium">Loading...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Notes Section -->
                <div class="bg-white rounded-xl shadow-sm p-6">
                    <h3 class="text-lg font-bold text-gray-900 mb-4">Notes</h3>
                    <div id="notesContent" class="bg-gray-50 rounded-lg p-4">
                        <p class="text-sm text-gray-700">Loading notes...</p>
                    </div>
                    <div class="mt-4">
                        <textarea id="newNote" class="w-full border border-gray-300 rounded-lg p-3 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" rows="3" placeholder="Add a new note..."></textarea>
                        <div class="mt-2 flex justify-end">
                            <button onclick="saveNote()" class="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700 transition-colors">
                                Save Note
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column - Timeline -->
            <div class="space-y-6">
                <!-- Activity Timeline -->
                <div class="bg-white rounded-xl shadow-sm p-6">
                <h3 class="text-lg font-bold text-gray-900 mb-4">Activity Timeline</h3>
                <div class="timeline-container">
                    <div id="timelineContent" class="space-y-0">
                        <div class="text-center py-8 text-gray-500">
                            <span class="material-symbols-outlined text-4xl mb-2">history</span>
                            <p>No activity yet</p>
                        </div>
                    </div>
                </div>
            </div>

                <!-- Quick Actions -->
                <div class="bg-white rounded-xl shadow-sm p-6">
                    <h3 class="text-lg font-bold text-gray-900 mb-4">Quick Actions</h3>
                    <div class="space-y-3">
                        <button onclick="openCalendarModal()" class="w-full flex items-center justify-between p-3 text-left bg-gray-50 hover:bg-gray-100 rounded-lg transition-colors">
                            <div class="flex items-center">
                                <span class="material-symbols-outlined text-blue-600 mr-3">event</span>
                                <span class="text-sm font-medium">Schedule Meeting</span>
                            </div>
                            <span class="material-symbols-outlined text-gray-400">chevron_right</span>
                        </button>
                        <button onclick="openEmailModal()" class="w-full flex items-center justify-between p-3 text-left bg-gray-50 hover:bg-gray-100 rounded-lg transition-colors">
                            <div class="flex items-center">
                                <span class="material-symbols-outlined text-green-600 mr-3">mail</span>
                                <span class="text-sm font-medium">Send Email</span>
                            </div>
                            <span class="material-symbols-outlined text-gray-400">chevron_right</span>
                        </button>
                        <button onclick="changeStatus()" class="w-full flex items-center justify-between p-3 text-left bg-gray-50 hover:bg-gray-100 rounded-lg transition-colors">
                            <div class="flex items-center">
                                <span class="material-symbols-outlined text-red-600 mr-3">flag</span>
                                <span class="text-sm font-medium">Change Status</span>
                            </div>
                            <span class="material-symbols-outlined text-gray-400">chevron_right</span>
                        </button>
                    </div>
                </div>

                
    <!-- Email Modal -->
    <div id="emailModal" class="hidden fixed inset-0 z-50 bg-black/50 flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-2xl w-full max-w-2xl shadow-2xl overflow-hidden animate-fadeIn">
            <!-- Header -->
            <div class="bg-gradient-to-r from-red-500 to-red-600 px-6 py-4 flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-white/20 rounded-full flex items-center justify-center">
                        <span class="material-symbols-outlined text-white">mail</span>
                    </div>
                    <div>
                        <h2 class="text-xl font-bold text-white">Compose Email</h2>
                        <p class="text-red-100 text-sm">Send email to lead</p>
                    </div>
                </div>
                <button onclick="closeEmailModal()" class="text-white hover:bg-white/20 rounded-full p-2 transition-colors">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>

            <!-- Form -->
            <form id="emailForm" class="p-6 space-y-4">
                <!-- To Field -->
                <div>
                    <label class="flex items-center text-sm font-semibold text-gray-700 mb-2">
                        <span class="material-symbols-outlined text-base mr-2">person</span>
                        Recipient
                    </label>
                    <div class="relative">
                        <input 
                            type="text" 
                            id="emailTo" 
                            class="w-full pl-4 pr-4 py-3 bg-gray-50 border-2 border-gray-200 rounded-xl focus:outline-none focus:border-red-500 focus:bg-white transition-all text-gray-700 font-medium" 
                            readonly 
                        />
                        <span class="absolute right-3 top-1/2 -translate-y-1/2 material-symbols-outlined text-gray-400 text-sm">lock</span>
                    </div>
                </div>

                <!-- Subject Field -->
                <div>
                    <label class="flex items-center text-sm font-semibold text-gray-700 mb-2">
                        <span class="material-symbols-outlined text-base mr-2">subject</span>
                        Subject
                    </label>
                    <input 
                        type="text" 
                        id="emailSubject" 
                        class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:outline-none focus:border-red-500 transition-all" 
                        placeholder="Enter email subject..." 
                        required 
                    />
                </div>

                <!-- Message Field -->
                <div>
                    <label class="flex items-center text-sm font-semibold text-gray-700 mb-2">
                        <span class="material-symbols-outlined text-base mr-2">description</span>
                        Message
                    </label>
                    <textarea 
                        id="emailBody" 
                        class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:outline-none focus:border-red-500 transition-all resize-none" 
                        rows="8" 
                        placeholder="Type your message here..." 
                        required
                    ></textarea>
                    <div class="flex items-center justify-between mt-2 text-xs text-gray-500">
                        <span class="flex items-center">
                            <span class="material-symbols-outlined text-sm mr-1">info</span>
                            Professional email signature will be added automatically
                        </span>
                        <span id="charCount">0 characters</span>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="flex items-center justify-between pt-4 border-t border-gray-200">
                    <button 
                        type="button" 
                        onclick="closeEmailModal()" 
                        class="px-6 py-2.5 text-sm font-semibold text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors"
                    >
                        Cancel
                    </button>
                    <div class="flex items-center space-x-3">
                        <!-- <button 
                            type="button"
                            class="px-4 py-2.5 text-sm font-semibold text-gray-600 hover:text-gray-800 hover:bg-gray-100 rounded-lg transition-colors flex items-center"
                        >
                            <span class="material-symbols-outlined text-base mr-1">schedule</span>
                            Schedule
                        </button> -->
                        <button 
                            type="submit" 
                            class="px-8 py-2.5 text-sm font-bold text-white bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 rounded-lg transition-all shadow-lg hover:shadow-xl flex items-center"
                        >
                            <span class="material-symbols-outlined text-base mr-2">send</span>
                            Send Email
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Calendar Event Modal (Compact Version) -->
    <div id="eventModal" class="hidden fixed inset-0 z-50 bg-black/50 flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-xl w-full max-w-xl shadow-2xl overflow-hidden animate-fadeIn">
            <!-- Header -->
            <div class="bg-gradient-to-r from-green-500 to-green-600 px-5 py-3 flex items-center justify-between">
                <div class="flex items-center space-x-2">
                    <div class="w-8 h-8 bg-white/20 rounded-full flex items-center justify-center">
                        <span class="material-symbols-outlined text-white text-lg">event</span>
                    </div>
                    <div>
                        <h2 class="text-lg font-bold text-white">Schedule Meeting</h2>
                        <p class="text-green-100 text-xs">Create a new calendar event</p>
                    </div>
                </div>
                <button onclick="closeEventModal()" class="text-white hover:bg-white/20 rounded-full p-1.5 transition-colors">
                    <span class="material-symbols-outlined text-sm">close</span>
                </button>
            </div>

            <!-- Form -->
            <form id="eventForm" class="p-3 space-y-1 text-sm">
                <!-- Title -->
                <div>
                    <label class="flex items-center font-semibold text-gray-700 mb-1.5">
                        <span class="material-symbols-outlined text-sm mr-1.5">title</span>
                        Meeting Title
                    </label>
                    <input 
                        type="text" 
                        id="eventTitle" 
                        class="w-full px-3 py-2 border-2 border-gray-200 rounded-lg focus:outline-none focus:border-green-500 transition-all" 
                        placeholder="Enter meeting title..." 
                        required 
                    />
                </div>

                <!-- Description -->
                <div>
                    <label class="flex items-center font-semibold text-gray-700 mb-1.5">
                        <span class="material-symbols-outlined text-sm mr-1.5">notes</span>
                        Description
                    </label>
                    <textarea 
                        id="eventDescription" 
                        class="w-full px-3 py-2 border-2 border-gray-200 rounded-lg focus:outline-none focus:border-green-500 transition-all resize-none" 
                        rows="3" 
                        placeholder="Add meeting agenda, notes, or details..."
                    ></textarea>
                </div>

                <!-- Participants -->
                <div>
                    <label class="flex items-center font-semibold text-gray-700 mb-1.5">
                        <span class="material-symbols-outlined text-sm mr-1.5">group</span>
                        Participants
                    </label>
                    <div id="participantsList" class="space-y-1 mb-2"></div>
                    <div class="flex gap-2">
                        <input 
                            type="email" 
                            id="participantEmailInput" 
                            class="flex-1 px-3 py-1.5 border-2 border-gray-200 rounded-lg focus:outline-none focus:border-green-500 transition-all text-sm" 
                            placeholder="Enter email address"
                        />
                        <button 
                            type="button" 
                            onclick="addParticipant()" 
                            class="px-3 py-1.5 bg-green-50 text-green-600 font-medium rounded-lg hover:bg-green-100 transition-colors flex items-center"
                        >
                            <span class="material-symbols-outlined text-sm mr-1">add</span>
                            Add
                        </button>
                    </div>
                    <p class="text-xs text-gray-500 mt-1">
                        ðŸ’¡ Lead's email will be automatically included.
                    </p>
                </div>

                <!-- Date & Time -->
                <div class="space-y-3">
                    <div>
                        <label class="flex items-center font-semibold text-gray-700 mb-1.5">
                            <span class="material-symbols-outlined text-sm mr-1.5">calendar_today</span>
                            Meeting Date
                        </label>
                        <input 
                            type="date" 
                            id="eventDate" 
                            class="w-full px-3 py-2 border-2 border-gray-200 rounded-lg focus:outline-none focus:border-green-500 transition-all" 
                            required 
                        />
                    </div>

                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="flex items-center font-semibold text-gray-700 mb-1.5">
                                <span class="material-symbols-outlined text-sm mr-1.5">schedule</span>
                                Start Time
                            </label>
                            <select 
                                id="eventStartTime" 
                                class="w-full px-3 py-2 border-2 border-gray-200 rounded-lg focus:outline-none focus:border-green-500 transition-all"
                                required
                            >
                                <option value="">Select time</option>
                            </select>
                        </div>

                        <div>
                            <label class="flex items-center font-semibold text-gray-700 mb-1.5">
                                <span class="material-symbols-outlined text-sm mr-1.5">schedule</span>
                                End Time
                            </label>
                            <select 
                                id="eventEndTime" 
                                class="w-full px-3 py-2 border-2 border-gray-200 rounded-lg focus:outline-none focus:border-green-500 transition-all"
                                required
                            >
                                <option value="">Select time</option>
                            </select>
                        </div>
                    </div>

                    <div id="durationHelper" class="hidden bg-green-50 border border-green-200 rounded-lg p-2 text-sm">
                        <div class="flex items-center text-green-800">
                            <span class="material-symbols-outlined text-sm mr-1">info</span>
                            <span id="durationText"></span>
                        </div>
                    </div>
                </div>

                <!-- Google Meet -->
                <div class="bg-green-50 border border-green-200 rounded-lg p-3 text-sm flex items-start space-x-2">
                    <span class="material-symbols-outlined text-green-600 text-sm mt-0.5">videocam</span>
                    <div>
                        <p class="font-semibold text-green-900">Google Meet Integration</p>
                        <p class="text-green-700 text-xs">A video link will be automatically generated.</p>
                    </div>
                </div>

                <!-- Buttons -->
                <div class="flex items-center justify-between pt-3 border-t border-gray-200">
                    <button 
                        type="button" 
                        onclick="closeEventModal()" 
                        class="px-4 py-1.5 text-sm font-semibold text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors"
                    >
                        Cancel
                    </button>
                    <div class="flex items-center space-x-2">
                        <!-- <button 
                            type="button"
                            class="px-3 py-1.5 text-sm font-semibold text-gray-600 hover:text-gray-800 hover:bg-gray-100 rounded-lg transition-colors flex items-center"
                        >
                            <span class="material-symbols-outlined text-sm mr-1">notifications</span>
                            Reminders
                        </button> -->
                        <button 
                            type="submit" 
                            class="px-6 py-1.5 text-sm font-bold text-white bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 rounded-lg shadow-md hover:shadow-lg flex items-center"
                        >
                            <span class="material-symbols-outlined text-sm mr-1">check</span>
                            Create
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Status Change Modal -->
    <div id="statusModal" class="hidden fixed inset-0 z-50 bg-black/40 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl w-full max-w-sm p-6 relative shadow-lg">
            <button onclick="closeStatusModal()" class="absolute top-3 right-3 text-gray-500 hover:text-gray-700">
                <span class="material-symbols-outlined text-2xl">close</span>
            </button>
            <h2 class="text-xl font-bold mb-4 text-gray-900">Change Status</h2>
            <div class="space-y-3">
                <select id="statusSelect" class="form-input">
                    <option value="New">New</option>
                    <option value="Assigned">Assigned</option>
                    <option value="In Process">In Process</option>
                    <option value="Converted">Converted</option>
                </select>
                <div class="flex justify-end space-x-2">
                    <button type="button" onclick="closeStatusModal()" class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">
                        Cancel
                    </button>
                    <button onclick="updateStatus()" class="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700 transition-colors">
                        Update Status
                    </button>
                </div>
            </div>
        </div>
    </div>


    <!-- Call Log Modal -->
    <div id="callLogModal" class="hidden fixed inset-0 z-50 bg-black/50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl w-full max-w-2xl shadow-2xl overflow-hidden animate-fadeIn">
            <!-- Modal Header -->
            <div class="bg-gradient-to-r from-green-500 to-green-600 px-6 py-4 flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-white/20 rounded-full flex items-center justify-center">
                        <span class="material-symbols-outlined text-white">call</span>
                    </div>
                    <div>
                        <h2 class="text-xl font-bold text-white">Log Call</h2>
                        <p class="text-green-100 text-sm">Record your conversation details</p>
                    </div>
                </div>
                <button onclick="closeCallLogModal()" class="text-white hover:bg-white/20 rounded-full p-2 transition-colors">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>

            <!-- Modal Content -->
            <form id="callLogForm" class="p-6 space-y-5 max-h-[70vh] overflow-y-auto">
                <!-- Subject -->
                <div>
                    <label for="callSubject" class="block text-sm font-semibold text-gray-700 mb-2">
                        <span class="material-symbols-outlined text-sm align-middle mr-1">subject</span>
                        Subject <span class="text-red-500">*</span>
                    </label>
                    <input 
                        type="text" 
                        id="callSubject" 
                        required
                        class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent"
                        placeholder="e.g., Follow-up call regarding course enrollment"
                    >
                </div>

                <!-- Date and Time -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="callDate" class="block text-sm font-semibold text-gray-700 mb-2">
                            <span class="material-symbols-outlined text-sm align-middle mr-1">calendar_today</span>
                            Date <span class="text-red-500">*</span>
                        </label>
                        <input 
                            type="date" 
                            id="callDate" 
                            required
                            class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent"
                        >
                    </div>
                    <div>
                        <label for="callTime" class="block text-sm font-semibold text-gray-700 mb-2">
                            <span class="material-symbols-outlined text-sm align-middle mr-1">schedule</span>
                            Time <span class="text-red-500">*</span>
                        </label>
                        <input 
                            type="time" 
                            id="callTime" 
                            required
                            class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent"
                        >
                    </div>
                </div>

                <!-- Lead Status -->
                <div>
                    <label for="callLeadStatus" class="block text-sm font-semibold text-gray-700 mb-2">
                        <span class="material-symbols-outlined text-sm align-middle mr-1">flag</span>
                        Lead Status <span class="text-red-500">*</span>
                    </label>
                    <select 
                        id="callLeadStatus" 
                        required
                        class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent appearance-none bg-white"
                    >
                        <!-- <option value="">Select Status</option> -->
                        <option value="Contacted">Contacted</option>
                        <option value="Lead">Lead</option>
                        <option value="Prospect">Prospect</option>
                        <option value="Opportunity">Opportunity</option>
                        <option value="Demo Booked">Demo Booked</option>
                        <option value="Demo Done">Demo Done</option>
                        <option value="Payment Info">Payment Info</option>
                        <option value="Payment Link">Payment Link</option>
                        <option value="Closed Won">Closed Won</option>
                        <option value="Closed Lost">Closed Lost</option>
                    </select>
                </div>

                <!-- Description -->
                <div>
                    <label for="callDescription" class="block text-sm font-semibold text-gray-700 mb-2">
                        <span class="material-symbols-outlined text-sm align-middle mr-1">description</span>
                        Description <span class="text-red-500">*</span>
                    </label>
                    <textarea 
                        id="callDescription" 
                        required
                        rows="4"
                        class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent resize-none"
                        placeholder="Describe the conversation details, key points discussed, next steps, etc."
                    ></textarea>
                    <p class="text-xs text-gray-500 mt-1">Provide a detailed summary of your call</p>
                </div>

                <!-- Call Type and Status -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="callType" class="block text-sm font-semibold text-gray-700 mb-2">
                            <span class="material-symbols-outlined text-sm align-middle mr-1">swap_calls</span>
                            Call Type <span class="text-red-500">*</span>
                        </label>
                        <select 
                            id="callType" 
                            required
                            class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent appearance-none bg-white"
                        >
                            <!-- <option value="">Select Type</option> -->
                            <option value="Outbound">Outbound</option>
                            <option value="Inbound">Inbound</option>
                        </select>
                    </div>
                    <div>
                        <label for="callStatus" class="block text-sm font-semibold text-gray-700 mb-2">
                            <span class="material-symbols-outlined text-sm align-middle mr-1">check_circle</span>
                            Call Status <span class="text-red-500">*</span>
                        </label>
                        <select 
                            id="callStatus" 
                            required
                            class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent appearance-none bg-white"
                        >
                            <!-- <option value="">Select Status</option> -->
                            <option value="Scheduled">Scheduled</option>
                            <option value="Completed">Completed</option>
                            <option value="Held">Held</option>
                            <option value="Not Held">Not Held</option>
                            <option value="DNP">DNP</option>
                        </select>
                    </div>
                </div>

                <!-- Duration -->
                <div>
                    <label for="callDuration" class="block text-sm font-semibold text-gray-700 mb-2">
                        <span class="material-symbols-outlined text-sm align-middle mr-1">timer</span>
                        Duration (minutes) <span class="text-red-500">*</span>
                    </label>
                    <input 
                        type="number" 
                        id="callDuration" 
                        required
                        min="0"
                        step="1"
                        class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent"
                        placeholder="Enter duration in minutes"
                    >
                    <p class="text-xs text-gray-500 mt-1">How long did the call last?</p>
                </div>

                <div id="audioUrlContainer" class="hidden">
                    <label for="callAudioUrl" class="block text-sm font-semibold text-gray-700 mb-2">
                        <span class="material-symbols-outlined text-sm align-middle mr-1">mic</span>
                        Audio URL
                    </label>
                    <input 
                        type="url" 
                        id="callAudioUrl" 
                        class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent"
                        placeholder="Enter the playback audio URL"
                    >
                    <p class="text-xs text-gray-500 mt-1">URL to the recorded call audio on your playback platform</p>
                </div>

                <!-- Action Buttons -->
                <div class="flex items-center justify-end space-x-3 pt-4 border-t border-gray-200">
                    <button 
                        type="button" 
                        onclick="closeCallLogModal()" 
                        class="px-6 py-2.5 text-sm font-semibold text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors"
                    >
                        Cancel
                    </button>
                    <button 
                        type="submit" 
                        class="px-6 py-2.5 text-sm font-semibold text-white bg-gradient-to-r from-green-500 to-green-600 rounded-lg hover:from-green-600 hover:to-green-700 transition-all shadow-lg hover:shadow-xl flex items-center space-x-2"
                    >
                        <span class="material-symbols-outlined text-base">save</span>
                        <span>Save Call Log</span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <style>
        /* Custom select arrow */
        select {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3E%3Cpath stroke='%236B7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3E%3C/svg%3E");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem;
        }
    </style>

    <script>
        const API_BASE_URL = 'https://crm-1-ss55.onrender.com';
        let authToken = localStorage.getItem('authToken');
        let currentLeadId = null;
        let currentLead = null;
        let googleConnected = false;
        let participants = [];


        function messageWhatsApp() {
            if (!currentLead || !currentLead.mobile_number) {
                showError('No phone number available for this lead');
                return;
            }
            
            // Clean the phone number
            const cleanNumber = currentLead.mobile_number.replace(/[\s\-\(\)\+]/g, '');
            
            // Open WhatsApp
            window.open(`https://wa.me/${cleanNumber}`, '_blank');
        }
        
        function addParticipant() {
        const input = document.getElementById('participantEmailInput');
        const email = input.value.trim();
        
        // Validate email
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!email) {
            showError('Please enter an email address');
            return;
        }
        if (!emailRegex.test(email)) {
            showError('Please enter a valid email address');
            return;
        }
        
        // Check for duplicates (including lead email)
        if (participants.includes(email)) {
            showError('This email is already added');
            return;
        }
        
        // Check if it's the same as lead email
        const leadEmail = currentLead.email || currentLead.email_address;
        if (email === leadEmail) {
            showError('Lead email is automatically included');
            return;
        }
        
        // Add to array
        participants.push(email);
        input.value = '';
        
        // Update UI
        renderParticipants();
        showSuccess('Participant added!');
    }

    function removeParticipant(email) {
        participants = participants.filter(e => e !== email);
        renderParticipants();
    }

    function renderParticipants() {
        const container = document.getElementById('participantsList');
        
        if (participants.length === 0) {
            container.innerHTML = '';
            return;
        }
        
        container.innerHTML = participants.map(email => `
            <div class="flex items-center justify-between bg-green-50 px-3 py-2 rounded-lg">
                <div class="flex items-center space-x-2">
                    <span class="material-symbols-outlined text-green-600 text-base">person</span>
                    <span class="text-sm font-medium text-gray-900">${email}</span>
                </div>
                <button 
                    type="button" 
                    onclick="removeParticipant('${email}')" 
                    class="text-red-500 hover:text-red-700 transition-colors"
                >
                    <span class="material-symbols-outlined text-base">close</span>
                </button>
            </div>
        `).join('');
    }
        

        // Get lead ID from URL parameters
        function getLeadIdFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('id');
        }

        async function apiRequest(endpoint, options = {}) {
            const url = `${API_BASE_URL}${endpoint}`;
            const config = {
                headers: {
                    'Content-Type': 'application/json',
                    ...(authToken && { 'Authorization': `Bearer ${authToken}` })
                },
                ...options
            };

            try {
                const response = await fetch(url, config);
                
                if (response.status === 401) {
                    localStorage.removeItem('authToken');
                    window.location.href = './login.html';
                    return;
                }
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }
                
                return await response.json();
            } catch (error) {
                console.error('API Error:', error);
                throw error;
            }
        }

        function refreshLeadData() {
        // Force reload from server, not cache
        loadLeadDetail();
    }

    async function loadLeadDetail() {
        const leadId = getLeadIdFromURL();
        if (!leadId) {
            showError('No lead ID provided');
            return;
        }

        currentLeadId = leadId;

        try {
            showLoading(true);
            hideError();
            
            const lead = await apiRequest(`/leads/${leadId}?t=${Date.now()}`);
            if (!lead) {
                showError('Lead not found');
                return;
            }

            currentLead = lead;
            populateLeadData(lead);

            // Just load communications - no separate activities needed!
            await loadCommunications(leadId);

            await checkGoogleStatus();

        } catch (error) {
            showError('Failed to load lead details: ' + error.message);
        } finally {
            showLoading(false);
        }
    }

        function populateLeadData(lead) {
            // Set avatar initials
            const firstName = lead.first_name || '';
            const lastName = lead.last_name || '';
            const initials = (firstName.charAt(0) + lastName.charAt(0)).toUpperCase() || '?';
            document.getElementById('leadAvatar').textContent = initials;

            // Set main header info
            const fullName = `${firstName} ${lastName}`.trim() || 'Unknown';
            document.getElementById('leadName').textContent = fullName;
            document.getElementById('fullName').textContent = fullName;
            
            const email = lead.email_address || 'Not provided';
            document.getElementById('leadEmail').textContent = email;
            document.getElementById('detailEmail').textContent = email;
            
            const phone = lead.mobile_number || 'Not provided';
            document.getElementById('leadPhone').textContent = phone;
            document.getElementById('detailPhone').textContent = phone;
            
            // FIXED: Set location properly
            const locationParts = [];
            if (lead.city) locationParts.push(lead.city);
            if (lead.state) locationParts.push(lead.state);
            if (lead.country) locationParts.push(lead.country);
            const location = locationParts.length > 0 ? locationParts.join(', ') : 'Not provided';
            
            document.getElementById('leadLocation').textContent = location;
            document.getElementById('detailLocation').textContent = location;

            // Set status with appropriate color
            const status = lead.status || 'New';
            const statusBadge = document.getElementById('leadStatusBadge');
            statusBadge.textContent = status;
            statusBadge.className = 'status-badge ' + getStatusColor(status);

            // FIXED: Set lead details with proper null handling
            document.getElementById('leadSource').textContent = lead.lead_source || 'Not specified';
            document.getElementById('courseInterest').textContent = lead.course_interested_in || 'Not specified';
            
            // Education info
            const educationParts = [];
            if (lead.qualification) educationParts.push(lead.qualification);
            if (lead.institute_name) educationParts.push(`from ${lead.institute_name}`);
            const education = educationParts.length > 0 ? educationParts.join(' ') : 'Not specified';
            document.getElementById('education').textContent = education;
            
            // FIXED: Assigned to - use the name from API
            document.getElementById('assignedTo').textContent = lead.assigned_to_name || 'Not assigned';
            
            // Opportunity amount
            if (lead.opportunity_amount && lead.opportunity_amount > 0) {
                document.getElementById('opportunityAmount').textContent = `$${parseFloat(lead.opportunity_amount).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
            } else {
                document.getElementById('opportunityAmount').textContent = 'Not specified';
            }

            // Set notes/description
            if (lead.description && lead.description.trim()) {
                document.getElementById('notesContent').innerHTML = `<p class="text-sm text-gray-700 whitespace-pre-wrap">${lead.description}</p>`;
            } else {
                document.getElementById('notesContent').innerHTML = `<p class="text-sm text-gray-500 italic">No notes added yet</p>`;
            }
        }

    //     async function loadActivities() {
    //     try {
    //         const activities = await apiRequest(`/leads/${currentLeadId}/activities`);
            
    //         if (!activities || activities.length === 0) {
    //             return; // Let renderTimeline handle the empty state
    //         }
            
    //         // Convert activities to match the communication format for unified display
    //         const formattedActivities = activities.map(activity => {
    //             // Convert UTC to IST (UTC + 5:30)
    //             const utcDate = new Date(activity.created_at);
    //             const istDate = new Date(utcDate.getTime() + (5.5 * 60 * 60 * 1000));
                
    //             return {
    //                 id: activity.id,
    //                 type: activity.type, // 'meeting', 'call', 'email'
    //                 subject: activity.description,
    //                 content: `By ${activity.user_name}`,
    //                 created_at: istDate.toISOString(),
    //                 scheduled_at: null,
    //                 completed_at: null,
    //                 status: 'completed',
    //                 meet_link: null,
    //                 user_id: null
    //             };
    //         });
            
    //         // Merge with existing communications and re-render
    //         const communications = await apiRequest(`/leads/${currentLeadId}/communications`);
    //         const allItems = [...communications, ...formattedActivities];
            
    //         // Sort by date (newest first)
    //         allItems.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
            
    //         renderTimeline(allItems);
            
    //     } catch (error) {
    //         console.error('Failed to load activities:', error);
    //     }
    // }

        function getStatusColor(status) {
            const colors = {
                'New': 'bg-blue-100 text-blue-800',
                'Assigned': 'bg-yellow-100 text-yellow-800',
                'In Process': 'bg-orange-100 text-orange-800',
                'Converted': 'bg-green-100 text-green-800'
            };
            return colors[status] || 'bg-gray-100 text-gray-800';
        }

    async function loadCommunications(leadId = null) {
        const targetLeadId = leadId || currentLeadId;
        if (!targetLeadId) return;

        try {
            const communications = await apiRequest(`/leads/${targetLeadId}/communications`);
            renderTimeline(communications);
        } catch (error) {
            console.error('Failed to load communications:', error);
            renderTimeline([]);
        }
    }

    function renderTimeline(comms) {
        const container = document.getElementById('timelineContent');
        
        if (!comms || comms.length === 0) {
            container.innerHTML = `
                <div class="text-center py-8 text-gray-500">
                    <span class="material-symbols-outlined text-4xl mb-2">history</span>
                    <p>No activity yet</p>
                </div>`;
            return;
        }

        container.innerHTML = comms.map(comm => {
            // Convert UTC to IST (UTC + 5:30)
            const utcDate = new Date(comm.created_at);
            const istDate = new Date(utcDate.getTime() + (5.5 * 60 * 60 * 1000));
            const createdTimeStr = istDate.toLocaleString('en-IN', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                hour12: true
            });
            
            // Format scheduled time if exists
            let scheduledTimeStr = '';
            if (comm.scheduled_at) {
                const scheduledUtc = new Date(comm.scheduled_at);
                const scheduledIst = new Date(scheduledUtc.getTime() + (5.5 * 60 * 60 * 1000));
                scheduledTimeStr = scheduledIst.toLocaleString('en-IN', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    hour12: true
                });
            }
            
            // Determine border color and icon based on type
            let borderColor = 'border-gray-400';
            let iconColor = 'text-gray-600';
            let icon = 'chat';
            let typeLabel = '';
            let statusBadgeHtml = '';
            
            if (comm.type === 'call') {
                borderColor = 'border-green-500';
                iconColor = 'text-green-600';
                icon = 'call';
                typeLabel = 'Call';
                
                // Add status badge for calls
                if (comm.status === 'scheduled') {
                    statusBadgeHtml = '<span class="text-xs px-2 py-1 rounded-full bg-blue-100 text-blue-800">Scheduled</span>';
                } else if (comm.status === 'held') {
                    statusBadgeHtml = '<span class="text-xs px-2 py-1 rounded-full bg-green-100 text-green-800">Held</span>';
                } else if (comm.status === 'not held') {
                    statusBadgeHtml = '<span class="text-xs px-2 py-1 rounded-full bg-red-100 text-red-800">Not Held</span>';
                } else if (comm.status === 'dnp') {
                    statusBadgeHtml = '<span class="text-xs px-2 py-1 rounded-full bg-yellow-100 text-yellow-800">DNP</span>';
                } else if (comm.status === 'completed') {
                    statusBadgeHtml = '<span class="text-xs px-2 py-1 rounded-full bg-green-100 text-green-800">Completed</span>';
                }

                
            } else if (comm.type === 'meeting') {
                borderColor = 'border-purple-500';
                iconColor = 'text-purple-600';
                icon = 'event';
                typeLabel = 'Meeting';
                
                // Add status badge for meetings
                if (comm.status === 'scheduled') {
                    statusBadgeHtml = '<span class="text-xs px-2 py-1 rounded-full bg-blue-100 text-blue-800">Scheduled</span>';
                } else if (comm.status === 'rescheduled') {
                    statusBadgeHtml = '<span class="text-xs px-2 py-1 rounded-full bg-orange-100 text-orange-800">Rescheduled</span>';
                } else if (comm.status === 'completed') {
                    statusBadgeHtml = '<span class="text-xs px-2 py-1 rounded-full bg-green-100 text-green-800">Completed</span>';
                } else if (comm.status === 'pending') {
                    statusBadgeHtml = '<span class="text-xs px-2 py-1 rounded-full bg-gray-100 text-gray-800">Pending</span>';
                }
                
            } else if (comm.type === 'email') {
                borderColor = 'border-blue-500';
                iconColor = 'text-blue-600';
                icon = 'email';
                typeLabel = 'Email';
                
                if (comm.status === 'completed') {
                    statusBadgeHtml = '<span class="text-xs px-2 py-1 rounded-full bg-green-100 text-green-800">Sent</span>';
                }
                
            } else if (comm.type === 'note') {
                borderColor = 'border-yellow-500';
                iconColor = 'text-yellow-600';
                icon = 'description';
                typeLabel = 'Note';
            }
            
            return `
                <div class="timeline-item bg-white border-l-4 ${borderColor} rounded-lg p-4 shadow-sm hover:shadow-md transition-shadow mb-3">
                    <div class="flex items-start justify-between mb-2">
                        <div class="flex items-center space-x-2">
                            <span class="material-symbols-outlined ${iconColor} text-xl">${icon}</span>
                            <span class="font-semibold text-gray-900">${comm.subject || 'Activity'}</span>
                        </div>
                        <div class="flex items-center gap-2">
                            ${statusBadgeHtml}
                            <span class="text-xs px-2 py-1 rounded-full bg-gray-100 text-gray-700">
                                ${typeLabel}
                            </span>
                        </div>
                    </div>
                    
                    ${comm.content ? `<p class="text-sm text-gray-700 mb-2 whitespace-pre-line">${comm.content}</p>` : ''}

                    ${comm.audio_url ? `
                        <div class="flex items-center text-sm mt-2">
                            <span class="material-symbols-outlined text-gray-500 text-base mr-1">play_circle</span>
                            <a href="${comm.audio_url}" target="_blank" class="text-blue-600 hover:underline">Listen to call recording</a>
                        </div>
                    ` : ''}
                    
                    ${comm.scheduled_at && comm.type !== 'call' ? `
                        <div class="text-sm text-gray-600 mb-2 flex items-center">
                            <span class="material-symbols-outlined text-sm mr-1">schedule</span>
                            <span class="font-medium">Scheduled for:</span> ${scheduledTimeStr} IST
                        </div>
                    ` : ''}
                    
                    <div class="flex items-center justify-between text-xs text-gray-500 mt-2 pt-2 border-t border-gray-100">
                        <span>Created: ${createdTimeStr} IST</span>
                        ${comm.meet_link ? `
                            <a href="${comm.meet_link}" target="_blank" class="text-blue-600 hover:underline flex items-center font-medium">
                                <span class="material-symbols-outlined text-sm mr-1">video_call</span>
                                Join Meeting
                            </a>
                        ` : ''}
                    </div>
                </div>
            `;
        }).join('');
    }

    // Add this function to your main JavaScript file or a common script
    function disableDuringProcess(button, actionFunction) {
    // If button is already disabled, do nothing
    if (button.disabled) return;
    
    // Store original text
    const originalText = button.innerHTML;
    
    // Disable button and show processing state
    button.disabled = true;
    button.innerHTML = '<span class="spinner"></span> Processing...';
    
    // Perform the action
    try {
        const result = actionFunction();
        
        // If the action returns a promise, wait for it
        if (result instanceof Promise) {
        result
            .finally(() => {
            // Re-enable button and restore text when done
            button.disabled = false;
            button.innerHTML = originalText;
            });
        } else {
        // If not a promise, re-enable immediately
        button.disabled = false;
        button.innerHTML = originalText;
        }
        
        return result;
    } catch (error) {
        // In case of error, re-enable the button
        button.disabled = false;
        button.innerHTML = originalText;
        throw error;
    }
    }

    // Helper function to format dates (if needed elsewhere)
    function formatISTDate(utcDateString) {
        if (!utcDateString) return '';
        const utcDate = new Date(utcDateString);
        const istDate = new Date(utcDate.getTime() + (5.5 * 60 * 60 * 1000));
        return istDate.toLocaleString('en-IN', {
            year: 'numeric',
            month: 'short',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit',
            hour12: true
        });
    }


        function formatDate(dateString) {
            if (!dateString) return 'Unknown date';
            const date = new Date(dateString);
            return date.toLocaleDateString() + ' at ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        }

        // Email functionality
        function openEmailModal() {
            if (!currentLead) return;
            
            document.getElementById('emailTo').value = currentLead.email_address || '';
            document.getElementById('emailSubject').value = `Follow up - ${currentLead.first_name} ${currentLead.last_name}`;
            document.getElementById('emailBody').value = `Dear ${currentLead.first_name},\n\n`;
            
            document.getElementById('emailModal').classList.remove('hidden');
        }

        function closeEmailModal() {
            document.getElementById('emailModal').classList.add('hidden');
        }


        // Generate time options for dropdowns
        function generateTimeOptions() {
            const times = [];
            for (let hour = 0; hour < 24; hour++) {
                for (let minute = 0; minute < 60; minute += 15) {
                    const hourStr = hour.toString().padStart(2, '0');
                    const minuteStr = minute.toString().padStart(2, '0');
                    const time24 = `${hourStr}:${minuteStr}`;
                    
                    const period = hour >= 12 ? 'PM' : 'AM';
                    const hour12 = hour === 0 ? 12 : hour > 12 ? hour - 12 : hour;
                    const display = `${hour12}:${minuteStr} ${period}`;
                    
                    times.push({ value: time24, display: display });
                }
            }
            return times;
        }

        function populateTimeDropdowns() {
            const times = generateTimeOptions();
            const startSelect = document.getElementById('eventStartTime');
            const endSelect = document.getElementById('eventEndTime');
            
            if (startSelect && endSelect) {
                const optionsHTML = times.map(t => 
                    `<option value="${t.value}">${t.display}</option>`
                ).join('');
                
                startSelect.innerHTML = '<option value="">Select time</option>' + optionsHTML;
                endSelect.innerHTML = '<option value="">Select time</option>' + optionsHTML;
            }
        }

        function updateDuration() {
            const startTime = document.getElementById('eventStartTime').value;
            const endTime = document.getElementById('eventEndTime').value;
            const durationHelper = document.getElementById('durationHelper');
            const durationText = document.getElementById('durationText');
            
            if (startTime && endTime) {
                const [startHour, startMin] = startTime.split(':').map(Number);
                const [endHour, endMin] = endTime.split(':').map(Number);
                
                let durationMinutes = (endHour * 60 + endMin) - (startHour * 60 + startMin);
                
                if (durationMinutes < 0) {
                    durationHelper.classList.remove('hidden', 'bg-green-50', 'border-green-200');
                    durationHelper.classList.add('bg-red-50', 'border-red-200');
                    durationText.className = 'text-red-800';
                    durationText.textContent = 'End time must be after start time';
                } else if (durationMinutes === 0) {
                    durationHelper.classList.add('hidden');
                } else {
                    durationHelper.classList.remove('hidden', 'bg-red-50', 'border-red-200');
                    durationHelper.classList.add('bg-green-50', 'border-green-200');
                    durationText.className = 'text-green-800';
                    
                    const hours = Math.floor(durationMinutes / 60);
                    const minutes = durationMinutes % 60;
                    
                    let durationStr = 'Meeting duration: ';
                    if (hours > 0) durationStr += `${hours} hour${hours > 1 ? 's' : ''}`;
                    if (hours > 0 && minutes > 0) durationStr += ' and ';
                    if (minutes > 0) durationStr += `${minutes} minute${minutes > 1 ? 's' : ''}`;
                    
                    durationText.textContent = durationStr;
                }
            } else {
                durationHelper.classList.add('hidden');
            }
        }

        function autoSetEndTime() {
            const startTime = document.getElementById('eventStartTime').value;
            const endTimeSelect = document.getElementById('eventEndTime');
            
            if (startTime && !endTimeSelect.value) {
                const [hour, minute] = startTime.split(':').map(Number);
                let newHour = hour + 1;
                if (newHour >= 24) newHour = 23;
                
                const endTime = `${newHour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
                endTimeSelect.value = endTime;
                updateDuration();
            }
        }

        // Add character counter for email
        const emailBodyElement = document.getElementById('emailBody');
        if (emailBodyElement) {
            emailBodyElement.addEventListener('input', function() {
                const charCount = document.getElementById('charCount');
                if (charCount) {
                    charCount.textContent = `${this.value.length} characters`;
                }
            });
        }
        // Calendar functionality
        function openCalendarModal() {
            if (!currentLead) return;
            
            // Populate time dropdowns
            const startSelect = document.getElementById('eventStartTime');
            if (startSelect && startSelect.options.length <= 1) {
                populateTimeDropdowns();
                
                startSelect.addEventListener('change', function() {
                    autoSetEndTime();
                    updateDuration();
                });
                
                const endSelect = document.getElementById('eventEndTime');
                endSelect.addEventListener('change', updateDuration);
            }
            
            const now = new Date();
            const dateStr = now.toISOString().split('T')[0];
            
            document.getElementById('eventDate').value = dateStr;
            document.getElementById('eventStartTime').value = '09:00';
            document.getElementById('eventEndTime').value = '10:00';
            document.getElementById('eventTitle').value = `Meeting with ${currentLead.first_name} ${currentLead.last_name}`;
            document.getElementById('eventDescription').value = `Discussion about ${currentLead.course_interested_in || 'course options'}`;
            
            updateDuration();
            document.getElementById('eventModal').classList.remove('hidden');
        }

        function closeEventModal() {
            document.getElementById('eventModal').classList.add('hidden');
        }

        // Status functionality
        function changeStatus() {
            if (!currentLead) return;
            
            document.getElementById('statusSelect').value = currentLead.status || 'New';
            document.getElementById('statusModal').classList.remove('hidden');
        }

        function closeStatusModal() {
            document.getElementById('statusModal').classList.add('hidden');
        }

        function updateStatus() {
            if (!currentLeadId) return;
            
            const statusButton = document.querySelector('button[onclick="updateStatus()"]');
            disableDuringProcess(statusButton, async () => {
                const newStatus = document.getElementById('statusSelect').value;
                
                try {
                    const updatedLead = await apiRequest(`/leads/${currentLeadId}`, {
                        method: 'PUT',
                        body: JSON.stringify({ status: newStatus })
                    });
                    
                    currentLead = updatedLead;
                    populateLeadData(updatedLead);
                    closeStatusModal();
                    showSuccess('Status updated successfully!');
                } catch (error) {
                    showError('Failed to update status: ' + error.message);
                }
            });
        }

        // Form submissions
        document.getElementById('emailForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const submitButton = this.querySelector('button[type="submit"]');
            disableDuringProcess(submitButton, async () => {
                if (!currentLeadId) return;

                const payload = {
                    lead_id: currentLeadId,
                    to: document.getElementById('emailTo').value,
                    subject: document.getElementById('emailSubject').value,
                    body: document.getElementById('emailBody').value
                };

                try {
                    if (googleConnected) {
                        // Send email through Gmail API
                        await apiRequest('/google/gmail/send-with-attachments', {
                            method: 'POST',
                            body: JSON.stringify(payload)
                        });
                        showSuccess('Email sent successfully via Gmail!');
                        
                        // REMOVE THIS LINE - Backend already creates the communication record
                        // await addCommunication({...});
                    } else {
                        // Fallback to regular email
                        window.open(`mailto:${payload.to}?subject=${encodeURIComponent(payload.subject)}&body=${encodeURIComponent(payload.body)}`);
                        showSuccess('Email client opened!');
                        
                        // KEEP THIS ONLY FOR NON-GMAIL CASE
                        // Add to timeline only when using regular email client
                        await addCommunication({
                            type: 'email',
                            subject: payload.subject,
                            content: 'Email sent to lead'  // Use content instead of description to match backend
                        });
                    }
                    
                    closeEmailModal();
                    
                    // Refresh communications to display the new entry
                    await loadCommunications(currentLeadId);
                    
                } catch (err) {
                    showError('Failed to send email: ' + err.message);
                }
            });
        });

        function showToast(message, type) {
            // Create toast element
            const toast = document.createElement('div');
            
            // Set style based on type
            let bgColor = 'bg-blue-100 border-blue-500';
            let icon = 'info';
            
            if (type === 'success') {
                bgColor = 'bg-green-100 border-green-500';
                icon = 'check_circle';
            } else if (type === 'error') {
                bgColor = 'bg-red-100 border-red-500';
                icon = 'error';
            }
            
            // Set toast content
            toast.className = `mb-3 p-3 rounded shadow-md border-l-4 ${bgColor} flex items-center`;
            toast.innerHTML = `
                <span class="material-symbols-outlined mr-2">${icon}</span>
                <div class="text-sm font-medium">${message}</div>
            `;
            
            // Add to container
            const container = document.getElementById('toast-container');
            container.appendChild(toast);
            
            // Remove after 3 seconds
            setTimeout(() => {
                toast.remove();
            }, 3000);
            }

            function showSuccess(message) {
            showToast(message, 'success');
            }

            function showError(message) {
            showToast(message, 'error');
            }

        document.getElementById('eventForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const submitButton = this.querySelector('button[type="submit"]');
            disableDuringProcess(submitButton, async () => {
                if (!currentLeadId) return;

                const date = document.getElementById('eventDate').value;
                const startTime = document.getElementById('eventStartTime').value;
                const endTime = document.getElementById('eventEndTime').value;

                if (!date || !startTime || !endTime) {
                    showError('Please select date and times.');
                    return;
                }

                const startDateTime = new Date(`${date}T${startTime}`);
                const endDateTime = new Date(`${date}T${endTime}`);

                if (endDateTime <= startDateTime) {
                    showError('End time must be after start time.');
                    return;
                }

                // Get current lead email to add as primary attendee
                const leadEmail = currentLead.email || currentLead.email_address;
                
                // Filter out empty emails and validate
                const validParticipants = participants.filter(email => {
                    return email && email.trim() !== '' && email.includes('@');
                });
                
                // Combine lead email with additional participants (only if lead email exists)
                const allAttendees = leadEmail 
                    ? [leadEmail, ...validParticipants]
                    : validParticipants;

                const payload = {
                    lead_id: currentLeadId,
                    title: document.getElementById('eventTitle').value.trim(),
                    description: document.getElementById('eventDescription').value.trim(),
                    start_time: startDateTime.toISOString(),
                    end_time: endDateTime.toISOString(),
                    // Only include attendee_emails if we have valid emails
                    ...(allAttendees.length > 0 && { attendee_emails: allAttendees }),
                    participants: validParticipants.join(',')  // Store additional participants
                };

                try {
                    if (googleConnected) {
                        await apiRequest('/google/calendar/event', {
                            method: 'POST',
                            body: JSON.stringify(payload)
                        });
                        showSuccess('Calendar event created successfully!');
                    } else {
                        const googleCalendarUrl = `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent(payload.title)}&details=${encodeURIComponent(payload.description)}&dates=${formatGoogleCalendarDate(payload.start_time)}/${formatGoogleCalendarDate(payload.end_time)}`;
                        window.open(googleCalendarUrl, '_blank');
                        showSuccess('Google Calendar opened!');
                    }
                    
                    closeEventModal();
                    
                    // ADD: Include participants in communication content
                    const commContent = participants.length > 0 
                        ? `Meeting scheduled with lead\n\nParticipants: ${allAttendees.join(', ')}`
                        : 'Meeting scheduled with lead';
                        
                    
                    // ADD: Reset participants after successful submission
                    participants = [];
                    renderParticipants();

                    await loadCommunications(currentLeadId);
                    
                } catch (err) {
                    showError('Failed to create event: ' + err.message);
                }
            });
        });


// UPDATE your existing closeEventModal function to include participant reset:

function closeEventModal() {
    document.getElementById('eventModal').classList.add('hidden');
    document.getElementById('eventForm').reset();
    // ADD: Reset participants when modal closes
    participants = [];
    renderParticipants();
}
        // ============================================
    // CALL LOG JAVASCRIPT FUNCTIONS
    // Add these to the <script> section in lead-detail.html
    // ============================================

    // Open Call Log Modal
    function openCallLogModal() {
        if (!currentLeadId) {
            showError('No lead selected');
            return;
        }
        
        // Set current date and time as default
        const now = new Date();
        const dateStr = now.toISOString().split('T')[0];
        const timeStr = now.toTimeString().split(' ')[0].substring(0, 5);
        
        document.getElementById('callDate').value = dateStr;
        document.getElementById('callTime').value = timeStr;
        
        // Pre-fill subject with lead name
        if (currentLead) {
            document.getElementById('callSubject').value = `Call with ${currentLead.first_name} ${currentLead.last_name}`;
            document.getElementById('callLeadStatus').value = currentLead.status || '';
        }
        
        document.getElementById('callLogModal').classList.remove('hidden');
    }

    // Close Call Log Modal
    function closeCallLogModal() {
        document.getElementById('callLogModal').classList.add('hidden');
        document.getElementById('callLogForm').reset();
        
    }

    // Show/hide the audio URL field based on call status
    document.addEventListener('DOMContentLoaded', function() {
        const callStatusSelect = document.getElementById('callStatus');
        const audioUrlContainer = document.getElementById('audioUrlContainer');
        
        if (callStatusSelect && audioUrlContainer) {
            // Initial check
            toggleAudioUrlField();
            
            // Add change listener
            callStatusSelect.addEventListener('change', toggleAudioUrlField);
            
            function toggleAudioUrlField() {
                const status = callStatusSelect.value;
                if (status === 'Held' || status === 'Completed') {
                    audioUrlContainer.classList.remove('hidden');
                } else {
                    audioUrlContainer.classList.add('hidden');
                    // Clear the field when hidden
                    document.getElementById('callAudioUrl').value = '';
                }
            }
        }
    });

    // Update the existing callLead function to open the call log modal
    function callLead() {
        if (!currentLead) {
            showError('No lead data available');
            return;
        }
        
        openCallLogModal();
        
    }

    // Handle Call Log Form Submission
    document.addEventListener('DOMContentLoaded', function() {
        const callLogForm = document.getElementById('callLogForm');
        if (callLogForm) {
            callLogForm.addEventListener('submit', function(e) {
                e.preventDefault();
                    
                const submitButton = this.querySelector('button[type="submit"]');
                disableDuringProcess(submitButton, async () => {
                    if (!currentLeadId) {
                        showError('No lead selected');
                        return;
                    }
                    
                    // Gather form data
                    const subject = document.getElementById('callSubject').value.trim();
                    const date = document.getElementById('callDate').value;
                    const time = document.getElementById('callTime').value;
                    const leadStatus = document.getElementById('callLeadStatus').value;
                    const description = document.getElementById('callDescription').value.trim();
                    const callType = document.getElementById('callType').value;
                    const callStatus = document.getElementById('callStatus').value;
                    const duration = parseInt(document.getElementById('callDuration').value);
                    
                    if (!subject || !date || !time || !leadStatus || !description || !callType || !callStatus || (duration === undefined || duration === null)) {
                        showError('Please fill in all required fields');
                        return;
                    }
                    
                    // Combine date and time
                    const callDateTime = new Date(`${date}T${time}`);
                    
                    // Prepare call log data - match the CommunicationCreate model
                    const callLogData = {
                        type: 'call',
                        subject: subject,
                        content: `Call Type: ${callType}\nStatus: ${callStatus}\nDuration: ${duration} minutes\n\nDescription:\n${description}`,
                        scheduled_at: callDateTime.toISOString(),
                        completed_at: callStatus === 'Held' ? callDateTime.toISOString() : null,
                        status: callStatus.toLowerCase(),
                        call_type: callType,
                        call_duration: duration,
                        audio_url: document.getElementById('callAudioUrl').value.trim() || null,
                        lead_status: leadStatus
                    };
                    
                    try {
                        // Save call log as communication
                        await apiRequest(`/leads/${currentLeadId}/communications`, {
                            method: 'POST',
                            body: JSON.stringify(callLogData)
                        });
                        
                        // Update lead status if changed
                        if (leadStatus && leadStatus !== currentLead.status) {
                            await apiRequest(`/leads/${currentLeadId}`, {
                                method: 'PUT',
                                body: JSON.stringify({ status: leadStatus })
                            });
                            
                            // Refresh lead data
                            await loadLeadDetail();
                        }
                        
                        showSuccess('Call logged successfully!');
                        closeCallLogModal();
                        
                        // Refresh communications timeline
                        await loadCommunications();
                        
                    } catch (error) {
                        console.error('Error logging call:', error);
                        showError('Failed to log call: ' + error.message);
                    }
                });
            });
        }
    });


    // Add function to display call logs in timeline
    function formatCallLog(comm) {
        const callData = parseCallLogContent(comm.content);

        let audioLinkHtml = '';
        if (comm.audio_url) {
            audioLinkHtml = `
                <div class="flex items-center text-sm mt-2">
                    <span class="material-symbols-outlined text-gray-500 text-base mr-1">play_circle</span>
                    <a href="${comm.audio_url}" target="_blank" class="text-blue-600 hover:underline">Listen to call recording</a>
                </div>
            `;
        }
        
        return `
            <div class="timeline-item bg-white border-l-4 border-green-500 rounded-lg p-4 shadow-sm hover:shadow-md transition-shadow">
                <div class="flex items-start justify-between mb-2">
                    <div class="flex items-center space-x-2">
                        <span class="material-symbols-outlined text-green-600 text-xl">call</span>
                        <span class="font-semibold text-gray-900">${comm.subject}</span>
                    </div>
                    <span class="text-xs px-2 py-1 rounded-full ${
                        callData.callType === 'Inbound' ? 'bg-green-100 text-green-800' : 'bg-blue-100 text-blue-800'
                    }">${callData.callType || 'Call'}</span>
                </div>
                <div class="space-y-2">
                    ${callData.callStatus ? `
                        <div class="flex items-center text-sm">
                            <span class="text-gray-600 font-medium mr-2">Status:</span>
                            <span class="px-2 py-0.5 rounded-full text-xs font-medium ${
                                callData.callStatus.toLowerCase() === 'held' ? 'bg-green-100 text-green-800' :
                                callData.callStatus.toLowerCase() === 'not held' ? 'bg-red-100 text-red-800' :
                                'bg-gray-100 text-gray-800'
                            }">${callData.callStatus}</span>
                        </div>
                    ` : ''}
                    ${callData.duration ? `
                        <div class="flex items-center text-sm text-gray-700">
                            <span class="material-symbols-outlined text-gray-500 text-base mr-1">schedule</span>
                            <span>${callData.duration} minutes</span>
                        </div>
                    ` : ''}
                    ${audioLinkHtml}
                    ${callData.description ? `
                        <div class="mt-2 text-sm text-gray-700 bg-gray-50 rounded p-2">
                            ${callData.description}
                        </div>
                    ` : ''}
                </div>
                <div class="mt-2 text-xs text-gray-500">${formatDate(comm.created_at)}</div>
            </div>
        `;
    }

    // Utility function to prevent duplicate submissions
    function disableDuringProcess(button, actionFunction) {
        // If button is already disabled, do nothing
        if (button.disabled) return;
        
        // Store original text
        const originalText = button.innerHTML;
        
        // Disable button and show processing state
        button.disabled = true;
        button.innerHTML = '<span class="spinner"></span> Processing...';
        
        // Perform the action
        try {
            const result = actionFunction();
            
            // If the action returns a promise, wait for it
            if (result instanceof Promise) {
            result
                .finally(() => {
                // Re-enable button and restore text when done
                button.disabled = false;
                button.innerHTML = originalText;
                });
            } else {
            // If not a promise, re-enable immediately
            button.disabled = false;
            button.innerHTML = originalText;
            }
            
            return result;
        } catch (error) {
            // In case of error, re-enable the button
            button.disabled = false;
            button.innerHTML = originalText;
            throw error;
        }
        }

    // Helper function to parse call log content
    function parseCallLogContent(content) {
        const lines = content.split('\n');
        const data = {
            callType: '',
            status: '',
            duration: 0,
            description: ''
        };
        
        let descriptionStarted = false;
        let descriptionLines = [];
        
        for (const line of lines) {
            if (line.startsWith('Call Type:')) {
                data.callType = line.replace('Call Type:', '').trim();
            } else if (line.startsWith('Status:')) {
                data.status = line.replace('Status:', '').trim();
            } else if (line.startsWith('Duration:')) {
                const match = line.match(/(\d+)/);
                if (match) data.duration = parseInt(match[1]);
            } else if (line.startsWith('Description:')) {
                descriptionStarted = true;
            } else if (descriptionStarted && line.trim()) {
                descriptionLines.push(line);
            }
        }
        
        data.description = descriptionLines.join('\n').trim();
        return data;
    }

    // Update the loadCommunications function to handle call logs
    // async function loadCommunications() {
    //     try {
    //         const comms = await apiRequest(`/leads/${currentLeadId}/communications`);
    //         const timeline = document.getElementById('communicationsTimeline');
            
    //         if (!comms || comms.length === 0) {
    //             timeline.innerHTML = '<p class="text-gray-500 text-sm">No activity yet</p>';
    //             return;
    //         }
            
    //         timeline.innerHTML = comms.map(comm => {
    //             if (comm.type === 'call') {
    //                 return formatCallLog(comm);
    //             } else if (comm.type === 'email') {
    //                 return formatEmailTimeline(comm);
    //             } else if (comm.type === 'meeting') {
    //                 return formatMeetingTimeline(comm);
    //             } else {
    //                 return formatNoteTimeline(comm);
    //             }
    //         }).join('');
            
    //     } catch (error) {
    //         console.error('Error loading communications:', error);
    //     }
    // }

    // Helper function to get status colors
    function getStatusColor(status) {
        const colors = {
            'New': 'bg-blue-100 text-blue-800',
            'Contacted': 'bg-green-100 text-green-800',
            'Lead': 'bg-yellow-100 text-yellow-800',
            'Prospect': 'bg-purple-100 text-purple-800',
            'Opportunity': 'bg-orange-100 text-orange-800',
            'Demo Booked': 'bg-indigo-100 text-indigo-800',
            'Demo Done': 'bg-teal-100 text-teal-800',
            'Payment Info': 'bg-pink-100 text-pink-800',
            'Payment Link': 'bg-rose-100 text-rose-800',
            'Closed Won': 'bg-green-200 text-green-900',
            'Closed Lost': 'bg-red-100 text-red-800',
            'Assigned': 'bg-blue-100 text-blue-800',
            'In Process': 'bg-yellow-100 text-yellow-800',
            'Converted': 'bg-green-100 text-green-800'
        };
        return colors[status] || 'bg-gray-100 text-gray-800';
    }

        // Google Workspace integration
        async function checkGoogleStatus() {
            try {
                const status = await apiRequest('/google/status');
                googleConnected = status.connected;

                const googleSection = document.getElementById('googleIntegration');
                const connectBtn = document.getElementById('connectGoogleBtn');
                const gmailBtn = document.getElementById('gmailBtn');
                const calendarBtn = document.getElementById('calendarBtn');

                if (googleConnected) {
                    googleSection.classList.remove('hidden');
                    connectBtn.classList.add('hidden');
                    gmailBtn.disabled = false;
                    calendarBtn.disabled = false;
                } else {
                    googleSection.classList.remove('hidden');
                    connectBtn.classList.remove('hidden');
                }
            } catch (error) {
                console.error('Failed to check Google status:', error);
            }
        }

        function connectGoogle() {
            // Redirect to Google OAuth or open connection modal
            showToast('Google Workspace connection would be implemented here', 'info');
        }

        // Utility functions
        function formatDateTimeLocal(date) {
            return date.toISOString().slice(0, 16);
        }

        function formatGoogleCalendarDate(dateString) {
            return new Date(dateString).toISOString().replace(/-|:|\.\d+/g, '');
        }

        async function addCommunication(communication) {
            try {
                await apiRequest(`/leads/${currentLeadId}/communications`, {
                    method: 'POST',
                    body: JSON.stringify(communication)
                });
                // Reload communications
                await loadCommunications(currentLeadId);
                // await loadActivities();
            } catch (error) {
                console.error('Failed to add communication:', error);
            }
        }

        function showLoading(show) {
            document.getElementById('loadingIndicator').classList.toggle('hidden', !show);
            document.getElementById('mainContent').classList.toggle('hidden', show);
        }

        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            document.getElementById('errorText').textContent = message;
            errorDiv.classList.remove('hidden');
        }

        function hideError() {
            document.getElementById('errorMessage').classList.add('hidden');
        }

        function showSuccess(message) {
            // Simple success notification - you can replace with a toast
            showToast(message, 'success');
        }

        function goBack() {
            window.history.back();
        }

        function saveNote() {
            const saveButton = document.querySelector('button[onclick="saveNote()"]');
            
            disableDuringProcess(saveButton, async () => {
                const noteText = document.getElementById('newNote').value.trim();
                if (!noteText) {
                    showError('Please enter a note');
                    return;
                }

                try {
                    // Update lead description
                    const updatedLead = await apiRequest(`/leads/${currentLeadId}`, {
                        method: 'PUT',
                        body: JSON.stringify({ 
                            description: noteText + (currentLead.description ? '\n\n' + currentLead.description : '')
                        })
                    });
                    
                    currentLead = updatedLead;
                    
                    // Update notes display
                    if (updatedLead.description && updatedLead.description.trim()) {
                        document.getElementById('notesContent').innerHTML = `<p class="text-sm text-gray-700 whitespace-pre-wrap">${updatedLead.description}</p>`;
                    } else {
                        document.getElementById('notesContent').innerHTML = `<p class="text-sm text-gray-500 italic">No notes added yet</p>`;
                    }
                    
                    document.getElementById('newNote').value = '';
                    showSuccess('Note saved successfully!');
                    
                    // Add to timeline as a communication
                    await addCommunication({
                        type: 'note',
                        subject: 'Note added',
                        content: noteText
                    });
                    
                } catch (error) {
                    showError('Failed to save note: ' + error.message);
                }
            });
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', () => {
            if (!authToken) {
                window.location.href = './login.html';
                return;
            }
            
            // Check if we're returning from an edit
            const justEdited = sessionStorage.getItem('leadJustEdited');
            if (justEdited) {
                sessionStorage.removeItem('leadJustEdited');
                showSuccess('Lead updated successfully!');
            }
            
            loadLeadDetail();
        });
    </script>

</body>
</html>