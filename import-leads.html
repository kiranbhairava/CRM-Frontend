<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <title>Gigaversity CRM - Import Leads</title>
    <link href="data:image/x-icon;base64," rel="icon" type="image/x-icon"/>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com"/>
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>

    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#1173d4",
                        "primary-dark": "#0d5bb5",
                        "background-light": "#f8fafc",
                    },
                    fontFamily: {
                        "display": ["Inter", "sans-serif"]
                    },
                },
            },
        }
    </script>

    <style>
        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        }
        .btn-primary { 
            background: linear-gradient(135deg,#1173d4 0%,#0d5bb5 100%); 
            box-shadow: 0 4px 12px rgba(17,115,212,0.3); 
        }
        .btn-primary:hover { 
            transform: translateY(-1px); 
            box-shadow: 0 6px 16px rgba(17,115,212,0.4); 
        }
        .page-transition { 
            animation: fadeIn 0.5s ease-in; 
        }
        @keyframes fadeIn { 
            from { opacity: 0; transform: translateY(20px); } 
            to { opacity: 1; transform: translateY(0); } 
        }
    </style>
</head>
<body class="font-display bg-background-light min-h-screen">

    <!-- Header -->
    <header class="bg-white/80 border-b border-gray-200 shadow-sm sticky top-0 z-10 backdrop-blur-lg">
        <div class="container mx-auto px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center space-x-4">
                    <button onclick="window.location.href='leads.html'" class="p-2 text-gray-600 hover:bg-gray-100 rounded-full transition-colors" aria-label="Go back">
                        <span class="material-symbols-outlined">arrow_back</span>
                    </button>
                    <div class="flex items-center space-x-3">
                        <span class="material-symbols-outlined text-primary text-3xl">school</span>
                        <h1 class="text-xl font-bold text-gray-900">Gigaversity CRM</h1>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <button onclick="logout()" class="text-sm font-medium text-gray-600 hover:text-gray-900">Logout</button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto max-w-4xl px-6 lg:px-8 py-8 page-transition">
        
        <!-- Page Header -->
        <div class="mb-8">
            <div class="flex items-center gap-4 mb-3">
                <div class="p-3 bg-primary/10 rounded-xl">
                    <span class="material-symbols-outlined text-primary text-4xl">upload_file</span>
                </div>
                <div>
                    <h2 class="text-3xl font-bold text-gray-900">Import Leads</h2>
                    <p class="text-gray-500 mt-1">Bulk upload leads from a CSV file</p>
                </div>
            </div>
        </div>

        <!-- Step-by-step Guide -->
        <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
            <h3 class="text-lg font-bold text-gray-900 mb-4">How it works</h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="flex flex-col items-center text-center">
                    <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center mb-3">
                        <span class="text-blue-600 font-bold text-lg">1</span>
                    </div>
                    <h4 class="font-semibold text-gray-900 mb-1">Download Template</h4>
                    <p class="text-sm text-gray-600">Get the CSV template with all required fields</p>
                </div>
                <div class="flex flex-col items-center text-center">
                    <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center mb-3">
                        <span class="text-green-600 font-bold text-lg">2</span>
                    </div>
                    <h4 class="font-semibold text-gray-900 mb-1">Fill Your Data</h4>
                    <p class="text-sm text-gray-600">Add your leads information to the template</p>
                </div>
                <div class="flex flex-col items-center text-center">
                    <div class="w-12 h-12 bg-purple-100 rounded-full flex items-center justify-center mb-3">
                        <span class="text-purple-600 font-bold text-lg">3</span>
                    </div>
                    <h4 class="font-semibold text-gray-900 mb-1">Upload & Import</h4>
                    <p class="text-sm text-gray-600">Upload your file and import all leads at once</p>
                </div>
            </div>
        </div>

        <!-- CSV Format Guide -->
        <div class="bg-gradient-to-br from-blue-50 to-indigo-50 border border-blue-200 rounded-xl p-6 mb-6">
            <div class="flex items-start gap-3 mb-4">
                <span class="material-symbols-outlined text-blue-600 text-2xl">info</span>
                <div class="flex-1">
                    <h3 class="font-bold text-blue-900 text-lg mb-2">CSV Format Requirements</h3>
                    
                    <div class="mb-4">
                        <p class="text-sm font-semibold text-blue-800 mb-2">✅ Required Columns:</p>
                        <div class="grid grid-cols-2 gap-2">
                            <span class="text-sm bg-white/60 px-3 py-1 rounded text-blue-900 font-mono">first_name</span>
                            <span class="text-sm bg-white/60 px-3 py-1 rounded text-blue-900 font-mono">last_name</span>
                            <span class="text-sm bg-white/60 px-3 py-1 rounded text-blue-900 font-mono">email_address</span>
                            <span class="text-sm bg-white/60 px-3 py-1 rounded text-blue-900 font-mono">mobile_number</span>
                        </div>
                    </div>

                    <div>
                        <p class="text-sm font-semibold text-blue-800 mb-2">📋 Optional Columns:</p>
                        <div class="text-xs text-blue-700 bg-white/40 p-3 rounded">
                            <code>salutation, alternate_mobile_number, working_status, street, postal_code, city, state, country, institute_name, qualification, course_interested_in, description, opportunity_amount, lead_source, referred_by, status, status_description, assigned_to</code>
                        </div>
                    </div>
                </div>
            </div>
            
            <button onclick="downloadTemplate()" class="flex items-center gap-2 bg-white text-primary font-semibold px-5 py-2.5 rounded-lg hover:bg-blue-50 transition-colors shadow-sm">
                <span class="material-symbols-outlined">download</span>
                Download CSV Template
            </button>
        </div>

        <!-- File Upload Section -->
        <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
            <h3 class="text-lg font-bold text-gray-900 mb-4">Upload Your File</h3>
            
            <!-- Drop Zone -->
            <div id="dropZone" class="border-2 border-dashed border-gray-300 rounded-xl p-12 text-center hover:border-primary hover:bg-primary/5 transition-all cursor-pointer">
                <span class="material-symbols-outlined text-gray-400 text-6xl mb-4">cloud_upload</span>
                <p class="text-gray-700 font-semibold text-lg mb-2">Drop your CSV file here</p>
                <p class="text-gray-500 mb-4">or click to browse from your computer</p>
                <p class="text-sm text-gray-400">Maximum file size: 5MB</p>
                <input type="file" id="csvFileInput" accept=".csv" class="hidden" onchange="handleFileSelect(event)">
            </div>
            
            <!-- Selected File Display -->
            <div id="selectedFile" class="hidden mt-6 p-5 bg-gradient-to-r from-green-50 to-emerald-50 border border-green-200 rounded-xl">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-4">
                        <div class="p-3 bg-white rounded-lg shadow-sm">
                            <span class="material-symbols-outlined text-green-600 text-3xl">description</span>
                        </div>
                        <div>
                            <p id="fileName" class="font-bold text-gray-900 text-lg"></p>
                            <p id="fileSize" class="text-sm text-gray-600"></p>
                        </div>
                    </div>
                    <button onclick="clearFile()" class="p-2 text-red-500 hover:bg-red-100 rounded-lg transition-colors">
                        <span class="material-symbols-outlined">close</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Progress Section -->
        <div id="uploadProgress" class="hidden bg-white rounded-xl shadow-sm p-6 mb-6">
            <div class="flex items-center justify-between mb-3">
                <span class="text-sm font-semibold text-gray-700">Uploading your file...</span>
                <span id="progressPercent" class="text-sm font-bold text-primary">0%</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-3 overflow-hidden">
                <div id="progressBar" class="bg-gradient-to-r from-primary to-blue-500 h-3 rounded-full transition-all duration-300" style="width: 0%"></div>
            </div>
        </div>

        <!-- Results Section -->
        <div id="uploadResults" class="hidden bg-white rounded-xl shadow-sm p-6 mb-6">
            <div id="resultsContent"></div>
        </div>

        <!-- Action Buttons -->
        <div class="flex gap-4">
            <button type="button" onclick="window.location.href='leads.html'" class="flex-1 px-6 py-3.5 text-sm font-semibold text-gray-700 bg-white border-2 border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">
                <span class="flex items-center justify-center gap-2">
                    <span class="material-symbols-outlined text-base">arrow_back</span>
                    Back to Leads
                </span>
            </button>
            <button type="button" onclick="uploadCSV()" id="uploadBtn" disabled class="flex-1 px-6 py-3.5 text-sm font-semibold btn-primary text-white rounded-lg transition-all disabled:opacity-50 disabled:cursor-not-allowed">
                <span class="flex items-center justify-center gap-2">
                    <span class="material-symbols-outlined text-base">upload</span>
                    Upload & Import Leads
                </span>
            </button>
        </div>

        <!-- Tips Section -->
        <div class="mt-8 bg-amber-50 border border-amber-200 rounded-xl p-6">
            <h3 class="font-bold text-amber-900 mb-3 flex items-center gap-2">
                <span class="material-symbols-outlined">lightbulb</span>
                Pro Tips
            </h3>
            <ul class="space-y-2 text-sm text-amber-800">
                <li class="flex items-start gap-2">
                    <span class="material-symbols-outlined text-base mt-0.5">check_circle</span>
                    <span>Ensure all email addresses are valid and properly formatted</span>
                </li>
                <li class="flex items-start gap-2">
                    <span class="material-symbols-outlined text-base mt-0.5">check_circle</span>
                    <span>Mobile numbers should include country code (e.g., +1234567890)</span>
                </li>
                <li class="flex items-start gap-2">
                    <span class="material-symbols-outlined text-base mt-0.5">check_circle</span>
                    <span>Use the exact column names from the template</span>
                </li>
                <li class="flex items-start gap-2">
                    <span class="material-symbols-outlined text-base mt-0.5">check_circle</span>
                    <span>Remove any blank rows before uploading</span>
                </li>
            </ul>
        </div>
    </main>

    <script>
        const API_BASE_URL = 'https://crm-1-ss55.onrender.com';
        let authToken = localStorage.getItem('authToken');
        let selectedFile = null;

        // Check authentication
        if (!authToken) {
            window.location.href = './login.html';
        }

        function logout() {
            localStorage.removeItem('authToken');
            window.location.href = './login.html';
        }

        // Drop zone functionality
        const dropZone = document.getElementById('dropZone');
        
        dropZone.addEventListener('click', () => {
            document.getElementById('csvFileInput').click();
        });

        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('border-primary', 'bg-primary/10');
        });

        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('border-primary', 'bg-primary/10');
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('border-primary', 'bg-primary/10');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        });

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                handleFile(file);
            }
        }

        function handleFile(file) {
            // Validate file type
            if (!file.name.endsWith('.csv')) {
                showWarning('Please select a CSV file');
                return;
            }

            // Validate file size (5MB limit)
            const maxSize = 5 * 1024 * 1024;
            if (file.size > maxSize) {
                showError('File size exceeds 5MB limit');
                return;
            }

            selectedFile = file;
            
            // Display selected file
            document.getElementById('fileName').textContent = file.name;
            document.getElementById('fileSize').textContent = formatFileSize(file.size);
            document.getElementById('selectedFile').classList.remove('hidden');
            document.getElementById('uploadBtn').disabled = false;
            
            // Scroll to selected file
            document.getElementById('selectedFile').scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        function clearFile() {
            selectedFile = null;
            document.getElementById('csvFileInput').value = '';
            document.getElementById('selectedFile').classList.add('hidden');
            document.getElementById('uploadBtn').disabled = true;
            document.getElementById('uploadResults').classList.add('hidden');
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }

        async function uploadCSV() {
            if (!selectedFile) {
                showWarning('Please select a file first');
                return;
            }

            const formData = new FormData();
            formData.append('file', selectedFile);

            try {
                // Show progress
                document.getElementById('uploadProgress').classList.remove('hidden');
                document.getElementById('uploadBtn').disabled = true;
                
                let progress = 0;
                const progressInterval = setInterval(() => {
                    progress += 10;
                    if (progress <= 90) {
                        updateProgress(progress);
                    }
                }, 200);

                const response = await fetch(`${API_BASE_URL}/leads/bulk`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: formData
                });

                clearInterval(progressInterval);
                updateProgress(100);

                const result = await response.json();

                if (response.ok) {
                    displayResults(result, true);
                    
                    // Redirect after success
                    setTimeout(() => {
                        window.location.href = 'leads.html';
                    }, 3000);
                } else {
                    displayResults(result, false);
                    document.getElementById('uploadBtn').disabled = false;
                }
            } catch (error) {
                console.error('Upload error:', error);
                showError('Failed to upload file: ' + error.message);
                document.getElementById('uploadProgress').classList.add('hidden');
                document.getElementById('uploadBtn').disabled = false;
            }
        }

        function updateProgress(percent) {
            document.getElementById('progressBar').style.width = percent + '%';
            document.getElementById('progressPercent').textContent = percent + '%';
        }

        function displayResults(result, isSuccess) {
            const resultsDiv = document.getElementById('uploadResults');
            const resultsContent = document.getElementById('resultsContent');
            
            resultsDiv.classList.remove('hidden');
            
            if (isSuccess) {
                let html = `
                    <div class="flex items-start gap-4">
                        <div class="p-3 bg-green-100 rounded-full">
                            <span class="material-symbols-outlined text-green-600 text-3xl">check_circle</span>
                        </div>
                        <div class="flex-1">
                            <h3 class="text-lg font-bold text-green-900 mb-2">Import Successful! 🎉</h3>
                            <p class="text-green-800 mb-3">${result.message}</p>
                `;
                
                if (result.errors && result.errors.length > 0) {
                    html += `
                        <div class="mt-4 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                            <p class="text-sm font-semibold text-yellow-800 mb-2">
                                ⚠️ ${result.errors.length} row(s) had errors:
                            </p>
                            <ul class="text-sm text-yellow-700 space-y-1 max-h-40 overflow-y-auto">
                                ${result.errors.slice(0, 10).map(err => `
                                    <li class="flex items-start gap-2">
                                        <span class="material-symbols-outlined text-xs mt-0.5">error</span>
                                        <span>Row ${err.row}: ${err.error}</span>
                                    </li>
                                `).join('')}
                                ${result.errors.length > 10 ? `<li class="font-semibold">... and ${result.errors.length - 10} more errors</li>` : ''}
                            </ul>
                        </div>
                    `;
                }
                
                html += `
                            <p class="text-sm text-gray-600 mt-4">Redirecting to leads page in 3 seconds...</p>
                        </div>
                    </div>
                `;
                resultsContent.innerHTML = html;
            } else {
                resultsContent.innerHTML = `
                    <div class="flex items-start gap-4">
                        <div class="p-3 bg-red-100 rounded-full">
                            <span class="material-symbols-outlined text-red-600 text-3xl">error</span>
                        </div>
                        <div>
                            <h3 class="text-lg font-bold text-red-900 mb-2">Upload Failed</h3>
                            <p class="text-red-800">${result.detail || 'Please check your file and try again'}</p>
                            <p class="text-sm text-red-600 mt-2">Make sure your CSV file matches the required format.</p>
                        </div>
                    </div>
                `;
            }
            
            document.getElementById('uploadProgress').classList.add('hidden');
            resultsDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        function downloadTemplate() {
            const csvContent = `first_name,last_name,email_address,mobile_number,salutation,alternate_mobile_number,working_status,street,postal_code,city,state,country,institute_name,qualification,course_interested_in,description,opportunity_amount,lead_source,referred_by,status,status_description,assigned_to
John,Doe,john.doe@example.com,+1234567890,Mr.,,Working,123 Main St,12345,New York,NY,USA,ABC University,Bachelor of Science,Web Development,Interested in full-stack course,5000,Website,,New,Initial contact made,
Jane,Smith,jane.smith@example.com,+0987654321,Ms.,,Student,456 Oak Ave,67890,Los Angeles,CA,USA,XYZ College,High School,Data Science,Looking for data analytics program,7500,Referral,John Doe,Assigned,Follow-up scheduled,`;

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', 'leads_import_template.csv');
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    </script>
</body>
</html>